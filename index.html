<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Autoâ€‘Crop Aramandi</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: sans-serif; text-align: center; background: #f7f7f7; color: #333; }
    h1 { margin: .5em 0; font-size: 1.6em; }
    #camera-container { position: relative; display: inline-block; }
    video, canvas {
      width: 360px; height: 640px;
      object-fit: cover;
      border-radius: 4px;
      background: #000;
    }
    #overlay { position: absolute; top: 0; left: 0; }
    .controls { margin-top: .5em; }
    button {
      padding: .6em 1em; margin: 0 .3em;
      font-size: 1em; border: none; border-radius: 4px;
      background: #fff; cursor: pointer;
      box-shadow: 0 1px 3px rgba(0,0,0,.2);
    }
    #countdown {
      font-size: 2em; color: #d00; margin-top: .5em;
      visibility: hidden;
    }
  </style>
  <!-- Mediapipe Pose -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
</head>
<body>
  <h1>Smart Autoâ€‘Crop Aramandi</h1>
  <p>Frame your full bodyâ€”when head & feet hit the 1st & 8th slices, weâ€™ll autoâ€‘capture.</p>

  <div id="camera-container">
    <video id="video" autoplay playsinline></video>
    <canvas id="overlay"></canvas>
  </div>

  <div id="countdown">5</div>

  <div class="controls">
    <button id="record-video-btn">ðŸŽ¥ Record 10Â s Video</button>
  </div>

  <script>
  (async()=>{
    const video = document.getElementById('video');
    const canvas= document.getElementById('overlay');
    const ctx   = canvas.getContext('2d');
    const countdownEl = document.getElementById('countdown');
    let pose, poses, raf, mediaRecorder, recordedChunks;

    // 1) start camera
    const stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:'user', width:360, height:640 }, audio:false
    });
    video.srcObject = stream;
    await new Promise(r=>video.onloadedmetadata=r);
    canvas.width = video.videoWidth;
    canvas.height= video.videoHeight;

    // 2) setup Mediapipe Pose
    pose = new Pose({locateFile: (f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${f}`});
    pose.setOptions({modelComplexity:0, smoothLandmarks:true, enableSegmentation:false});
    pose.onResults(r=>poses=r);

    // 3) helper: get forehead via inner eyes midpoint + mirror distance
    function estimateForehead(lm){
      const le = lm[Pose.POSE_LANDMARKS.LEFT_EYE_INNER];
      const re = lm[Pose.POSE_LANDMARKS.RIGHT_EYE_INNER];
      const no = lm[Pose.POSE_LANDMARKS.NOSE];
      const ex = (le.x+re.x)/2, ey=(le.y+re.y)/2;
      const d  = no.y - ey;
      return {x:ex, y:ey - d*.8};  // up a bit less for forehead
    }

    // 4) draw loop
    function draw(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      // eight head slices
      const H = canvas.height, W = canvas.width;
      const sliceH = H/8;
      let headOK=false, feetOK=false;
      if(poses && poses.poseLandmarks){
        const lm = poses.poseLandmarks;
        const fh = estimateForehead(lm);
        const heely = (lm[Pose.POSE_LANDMARKS.LEFT_HEEL].y + lm[Pose.POSE_LANDMARKS.RIGHT_HEEL].y)/2;
        headOK = fh.y*H <= sliceH*1.1 && fh.y*H >= sliceH*0.8;
        feetOK= heely*H >= sliceH*7*.9 && heely*H <= sliceH*8*1.1;
      }
      // border
      ctx.lineWidth=6;
      ctx.strokeStyle = (headOK&&feetOK)?'#0a0':'#a00';
      ctx.strokeRect(0,0,W,H);

      // orange "stand here" at bottom slice
      ctx.fillStyle='#f90';
      ctx.fillRect(0,H - sliceH, W, sliceH);
      ctx.fillStyle='#fff';
      ctx.font='bold 20px sans-serif';
      ctx.textAlign='center';
      ctx.fillText('Stand here â†’', W/2, H - sliceH/2 + 6);

      // dashed slice lines & numbers
      ctx.strokeStyle='#ff0';
      ctx.lineWidth=2; ctx.setLineDash([4,4]);
      for(let i=1;i<8;i++){
        const y=i*sliceH;
        ctx.beginPath();
        ctx.moveTo(0,y);
        ctx.lineTo(W,y);
        ctx.stroke();
        ctx.fillText(i, 10, y-6);
      }
      ctx.setLineDash([]);

      // if both valid, autoâ€‘capture
      if(headOK && feetOK){
        cancelAnimationFrame(raf);
        startCountdownAndCapture(5);
        return;
      }
      raf = requestAnimationFrame(draw);
    }

    video.play();
    await tf.setBackend('webgl');
    video.addEventListener('play', ()=>{
      (async function loop(){
        await pose.send({image:video});
        raf = requestAnimationFrame(loop);
      })();
      draw();
    });

    // 5) countdown UI + capture snapshot
    function startCountdownAndCapture(sec){
      countdownEl.style.visibility='visible';
      let s=sec;
      countdownEl.textContent = s;
      const iv = setInterval(()=>{
        s--, countdownEl.textContent=s;
        if(s<=0){
          clearInterval(iv);
          countdownEl.style.visibility='hidden';
          // capture final
          const c = document.createElement('canvas');
          c.width=W; c.height=H;
          c.getContext('2d').drawImage(video,0,0);
          c.toBlob(b=>{
            const a=document.createElement('a');
            a.href=URL.createObjectURL(b);
            a.download='aramandi.png';
            a.click();
          }, 'image/png');
        }
      },1000);
    }

    // 6) record 10Â s video (must click manually)
    document.getElementById('record-video-btn').onclick = ()=>{
      if(!MediaRecorder) return alert('Browser unsupported');
      recordedChunks=[];
      mediaRecorder = new MediaRecorder(stream, {mimeType:'video/webm'});
      mediaRecorder.ondataavailable = e=>e.data.size&&recordedChunks.push(e.data);
      mediaRecorder.onstop = ()=>{
        const blob = new Blob(recordedChunks,{type:'video/webm'});
        const url  = URL.createObjectURL(blob);
        const a    = document.createElement('a');
        a.href     = url;
        a.download = 'aramandi.webm';
        a.click();
      };
      // run the same 5s countdown
      startCountdownAndCapture(5);
      setTimeout(()=>mediaRecorder.start(), 5000);
      setTimeout(()=>mediaRecorder.state==='recording'&&mediaRecorder.stop(), 15000);
    };

  })();
  </script>
</body>
</html>
