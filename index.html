<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Autoâ€‘Crop Aramandi</title>
  <style>
    * { box-sizing: border-box; margin:0; padding:0;font-family:sans-serif }
    body { background:#f7f7f7; color:#333; text-align:center; padding:1em }
    h1 { margin-bottom:0.2em }
    p { margin-bottom:1em }

    .wrapper {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: flex-start;
      gap:1em;
    }
    .video-container {
      position: relative;
      width: 100%; max-width:360px;
      aspect-ratio: 9/16;
    }
    video, canvas {
      position:absolute; top:0; left:0;
      width:100%; height:100%;
      object-fit: cover;
    }
    .controls {
      display:flex;
      flex-direction:column;
      gap:0.5em;
      max-width:200px;
      width:100%;
    }
    .controls button {
      padding:0.6em;
      font-size:1em;
      border:1px solid #666;
      background:#fff;
      border-radius:4px;
      cursor:pointer;
    }
    #countdown {
      font-size:2em;
      font-weight:bold;
      color:#222;
      min-height:1.2em;
    }
    @media (max-width:700px) {
      .wrapper { flex-direction:column; align-items:center }
    }
  </style>
</head>
<body>
  <h1>Smart Autoâ€‘Crop Aramandi</h1>
  <p>Clear the top slice with your head and land your feet on the orange bar to autoâ€‘capture.</p>

  <div class="wrapper">
    <div class="video-container">
      <video id="video" autoplay playsinline></video>
      <canvas id="overlay"></canvas>
    </div>
    <div class="controls">
      <div id="countdown"></div>
      <button id="reset">ðŸ”„ Reset</button>
      <button id="capture">ðŸ“¸ Manual Capture</button>
    </div>
  </div>

  <!-- Load MP Pose + camera utils -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js"></script>

  <script>
    const videoElem = document.getElementById('video');
    const canvasElem = document.getElementById('overlay');
    const ctx = canvasElem.getContext('2d');
    const btnReset = document.getElementById('reset');
    const btnCapture = document.getElementById('capture');
    const countdownDiv = document.getElementById('countdown');

    let countdownTimer = null;
    let countdownValue = 0;

    // ask for camera
    navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user' }, audio:false })
      .then(stream => { videoElem.srcObject = stream; })
      .catch(err => alert("âŒ Camera access needed. " + err.message));

    videoElem.addEventListener('loadedmetadata', () => {
      canvasElem.width = videoElem.videoWidth;
      canvasElem.height = videoElem.videoHeight;
    });

    // draw everything per frame
    function onResults(results) {
      const W = canvasElem.width, H = canvasElem.height;
      ctx.clearRect(0,0,W,H);

      // 1) draw red/green border
      const aligned = checkAlignment(results);
      ctx.lineWidth = 6;
      ctx.strokeStyle = aligned ? 'lime' : 'red';
      ctx.strokeRect(0,0,W,H);

      // 2) dashed yellow slices
      const slice = H / 8;
      ctx.lineWidth = 2;
      ctx.strokeStyle = 'yellow';
      ctx.setLineDash([8,4]);
      for(let i=1; i<8; i++){
        const y = slice * i;
        ctx.beginPath();
        ctx.moveTo(0,y);
        ctx.lineTo(W,y);
        ctx.stroke();
      }
      ctx.setLineDash([]);

      // 3) orange "feet bar" at bottom slice
      ctx.fillStyle = 'orange';
      ctx.fillRect(0, 7*slice - 4, W, 8);

      // 4) if newly aligned, start countdown; if lost alignment, reset countdown
      if(aligned && !countdownTimer) startCountdown();
      if(!aligned && countdownTimer) resetCountdown();
    }

    // check if head < slice1  AND feet > slice7 (within some margin)
    function checkAlignment(results) {
      if(!results.poseLandmarks) return false;
      const lm = results.poseLandmarks;
      const nose = lm[0]; // nose tip is landmark 0
      const leftHeel = lm[Pose.PoseLandmark.LEFT_HEEL];
      const rightHeel = lm[Pose.PoseLandmark.RIGHT_HEEL];
      const H = canvasElem.height;
      const slice = H/8;

      const noseY = nose.y * H;
      const heelY = ((leftHeel.y + rightHeel.y)/2) * H;

      // head above top slice & feet on orange bar (Â±10px tolerance)
      return noseY < slice &&
             heelY > 7*slice - 10 &&
             heelY < 7*slice + 10;
    }

    function startCountdown() {
      countdownValue = 5;
      countdownDiv.textContent = countdownValue;
      countdownTimer = setInterval(()=>{
        countdownValue--;
        countdownDiv.textContent = countdownValue>0 ? countdownValue : '';
        if(countdownValue <= 0) {
          clearInterval(countdownTimer);
          countdownTimer = null;
          doCapture();
        }
      }, 1000);
    }
    function resetCountdown() {
      clearInterval(countdownTimer);
      countdownTimer = null;
      countdownDiv.textContent = '';
    }

    // manual capture handler
    btnCapture.onclick = () => {
      if(countdownTimer) return;  // already counting
      startCountdown();
    };

    // reset everything
    btnReset.onclick = () => {
      resetCountdown();
    };

    // actually grab a still
    function doCapture() {
      const snap = document.createElement('canvas');
      snap.width = videoElem.videoWidth;
      snap.height = videoElem.videoHeight;
      snap.getContext('2d').drawImage(videoElem,0,0);
      snap.toBlob(blob => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'aramandi.png';
        a.click();
        URL.revokeObjectURL(a.href);
      }, 'image/png');
    }

    // set up MediaPipe Pose + camera
    const pose = new Pose.Pose({
      locateFile: f=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${f}`
    });
    pose.setOptions({
      modelComplexity: 0,
      smoothLandmarks: true,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });
    pose.onResults(onResults);

    const camera = new Camera.Camera(videoElem, {
      onFrame: async ()=>{ await pose.send({image: videoElem}); },
      width: 720, height: 1280
    });
    camera.start();
  </script>
</body>
</html>
