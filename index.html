<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Autoâ€‘Crop Aramandi</title>
  <style>
    body { font-family:sans-serif; text-align:center; margin:0; padding:1em; background:#f7f7f7; }
    h1 { margin-bottom:0.2em; }
    #camera-container {
      position:relative;
      display:inline-block;
      border:6px solid red;
      max-width:360px;
      width:100%;
      aspect-ratio:9/16;
      background:#000;
      overflow:hidden;
    }
    video, canvas {
      position:absolute; top:0; left:0;
      width:100%; height:100%;
      object-fit:cover;
    }
    #status {
      margin-top:.5em;
      font-size:1.1em;
    }
    #controls {
      margin-top:1em;
      display:flex; justify-content:center; gap:1em;
    }
    button {
      padding:.5em 1em; font-size:1em;
      border:1px solid #888; border-radius:4px;
      background:#fff; cursor:pointer;
    }
    #counter {
      font-size:2em; font-weight:bold;
      position:absolute; top:50%; left:50%;
      transform:translate(-50%,-50%);
      color:white; text-shadow:0 0 5px black;
      display:none;
    }
  </style>
</head>
<body>
  <h1>Smart Autoâ€‘Crop Aramandi</h1>
  <p id="instructions">Frame your full bodyâ€”clear the top slice with your head and land your feet on the orange bar to autoâ€‘capture.</p>

  <div id="camera-container">
    <video id="video" autoplay playsinline></video>
    <canvas id="overlay"></canvas>
    <div id="counter">5</div>
  </div>
  <div id="status">Initializingâ€¦</div>

  <div id="controls">
    <button id="btn-reset">ðŸ”„ Reset</button>
    <button id="btn-capture">ðŸ“¸ Manual Capture</button>
    <button id="btn-record">ðŸŽ¥ 10Â s Record</button>
  </div>

  <script type="module">
    import { Pose } from 'https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js';
    import { Camera } from 'https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.4/camera_utils.js';

    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const ctx     = overlay.getContext('2d');
    const status  = document.getElementById('status');
    const counter = document.getElementById('counter');
    const container = document.getElementById('camera-container');
    let capturing = false;

    // set up MediaPipe Pose
    const pose = new Pose({
      locateFile: f=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${f}`
    });
    pose.setOptions({
      modelComplexity: 1,
      smoothLandmarks: true,
      enableSegmentation: false,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });
    pose.onResults(onPoseResults);

    // camera helper
    new Camera(video, {
      onFrame: async () => {
        await pose.send({image:video});
      },
      width:640, height:1136
    }).start();

    // resize overlay to match video
    video.addEventListener('loadedmetadata', ()=>{
      overlay.width = video.videoWidth;
      overlay.height= video.videoHeight;
    });

    // draw all the guides
    function drawGuides(color) {
      const W = overlay.width, H = overlay.height;
      ctx.clearRect(0,0,W,H);

      // border
      container.style.borderColor = color;

      // 8 equal slices
      const seg = H/8;
      ctx.strokeStyle = color==='lime' ? 'lime' : 'yellow';
      ctx.lineWidth = 2;
      ctx.setLineDash([6,4]);
      for(let i=1; i<8; i++){
        ctx.beginPath();
        ctx.moveTo(0, seg*i);
        ctx.lineTo(W, seg*i);
        ctx.stroke();
      }
      ctx.setLineDash([]);

      // orange bar at 8th slice
      ctx.fillStyle = 'orange';
      ctx.fillRect(0, seg*7, W, seg*0.3);
    }

    // main pose callback
    function onPoseResults(results) {
      if (!overlay.width) return;  // not ready yet
      const lm = results.poseLandmarks;
      drawGuides(capturing? 'lime' : 'red');

      if (!lm) {
        status.textContent = 'âŒ No body detected';
        return;
      }

      // compute y of forehead via eye inner & nose
      const L = lm[Pose.PoseLandmark.LEFT_EYE_INNER];
      const R = lm[Pose.PoseLandmark.RIGHT_EYE_INNER];
      const N = lm[Pose.PoseLandmark.NOSE];
      const eyeY = (L.y+R.y)/2;
      const dY   = N.y - eyeY;
      const fhY  = eyeY - dY;

      // foot Y = max heel
      const HL = lm[Pose.PoseLandmark.LEFT_HEEL].y;
      const HR = lm[Pose.PoseLandmark.RIGHT_HEEL].y;
      const ftY = Math.max(HL,HR);

      // full-body span test
      const span = ftY - fhY;
      if (span < 0.6) {
        status.textContent = 'â— Please step back so your full body fits';
        capturing = false;
        return;
      }

      // pixel positions
      const pixelHead = fhY * overlay.height;
      const pixelFoot = ftY * overlay.height;
      const topSlice  = overlay.height / 8;
      const barTop    = overlay.height * 7/8;

      // alignment logic
      const headClear = pixelHead < topSlice;
      const feetOnBar = pixelFoot > barTop && pixelFoot < overlay.height;

      if (headClear && feetOnBar) {
        status.textContent = 'âœ… Aligned! Capturing in 5Â sâ€¦';
        if (!capturing) startAutoCapture();
      } else {
        capturing = false;
        status.textContent = headClear
          ? 'â— Move your feet onto the orange bar'
          : 'â— Lift your head above the top line';
      }
    }

    // countdown + autoâ€‘capture
    function startAutoCapture() {
      capturing = true;
      let t=5;
      counter.style.display='block';
      counter.textContent = t;
      const iv = setInterval(()=>{
        t--;
        counter.textContent = t>0?t:'';
        if (t<=0) {
          clearInterval(iv);
          counter.style.display='none';
          doCapture();
        }
      },1000);
    }

    // snapshot
    function doCapture() {
      const c = document.createElement('canvas');
      c.width  = video.videoWidth;
      c.height = video.videoHeight;
      c.getContext('2d').drawImage(video,0,0);
      c.toBlob(b=>{
        const a=document.createElement('a');
        a.href=URL.createObjectURL(b);
        a.download='aramandi.png';
        a.click();
      }, 'image/png');
    }

    // manual capture button
    document.getElementById('btn-capture').onclick = ()=>{
      if (capturing) return;
      status.textContent = 'ðŸ“¸ Manual capture in 5Â sâ€¦';
      startAutoCapture();
    };

    // reset alignment
    document.getElementById('btn-reset').onclick = ()=>{
      capturing = false;
      status.textContent = 'ðŸ”„ Reset â€” step back into frame';
    };

    // record 10Â s video
    document.getElementById('btn-record').onclick = ()=>{
      if (!navigator.mediaDevices || !window.MediaRecorder) {
        return alert('Recording not supported');
      }
      let t=5;
      counter.style.display='block';
      counter.textContent = t;
      const iv = setInterval(()=>{
        t--;
        counter.textContent = t>0?t:'';
        if (t<=0) {
          clearInterval(iv);
          counter.style.display='none';
          const rec = new MediaRecorder(video.srcObject);
          const chunks=[];
          rec.ondataavailable = e=>chunks.push(e.data);
          rec.onstop = ()=>{
            const b=new Blob(chunks, {type: 'video/webm'});
            const a=document.createElement('a');
            a.href=URL.createObjectURL(b);
            a.download='aramandi.webm';
            a.click();
          };
          rec.start();
          setTimeout(()=>rec.stop(),10000);
        }
      },1000);
    };
  </script>
</body>
</html>
