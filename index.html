<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Autoâ€‘Crop Aramandi</title>
  <style>
    * { box-sizing: border-box; margin:0; padding:0 }
    body { font-family:sans-serif; background:#f7f7f7; text-align:center; padding:1em }
    h1 { margin-bottom:0.2em }
    p { margin-bottom:1em }
    #camera-container {
      position:relative;
      margin:0 auto;
      width:100%; max-width:360px;
      aspect-ratio:9/16;
      background:#000;
      overflow:hidden;
    }
    video, canvas {
      position:absolute; top:0; left:0;
      width:100%; height:100%;
      object-fit:cover;
    }
    .controls {
      display:flex; flex-direction:column; align-items:center; gap:0.5em;
      margin-top:1em;
    }
    .controls button {
      width:140px; padding:0.6em; font-size:1em;
      border:1px solid #888; background:#fff; border-radius:4px;
      cursor:pointer;
    }
    /* On desktop push controls to the right of video */
    @media(min-width:600px){
      .wrapper{ display:flex; justify-content:center; align-items:flex-start; gap:1em }
      .controls{ margin-top:0 }
    }
  </style>

  <!-- Mediapipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
</head>
<body>
  <h1>Smart Autoâ€‘Crop Aramandi</h1>
  <p>Get fullâ€‘body in view â€” when your forehead clears the top slice and heels land on the orange bar, youâ€™re <strong>INÂ FRAME</strong>. Pose for 10â€¯s to autoâ€‘capture.</p>

  <div class="wrapper">
    <div id="camera-container">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="overlay"></canvas>
    </div>
    <div class="controls">
      <button id="reset">ðŸ”„ Reset</button>
      <button id="manual">ðŸ“¸ Manual (5â€¯s)</button>
    </div>
  </div>

  <script>
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const ctx     = overlay.getContext('2d');
    const btnReset= document.getElementById('reset');
    const btnManual = document.getElementById('manual');

    let inFrame = false, countdownTimeout;

    // lay out our orange bar (slice 8) and yellow slices
    function drawOverlay() {
      const W = overlay.width, H = overlay.height;
      ctx.clearRect(0,0,W,H);

      // slices
      const seg = H/8;
      ctx.lineWidth = 2;
      ctx.strokeStyle = 'yellow';
      ctx.setLineDash([5,5]);
      ctx.font = '18px sans-serif';
      ctx.fillStyle = 'yellow';
      for(let i=1;i<8;i++){
        const y = seg*i;
        ctx.beginPath();
        ctx.moveTo(0,y);
        ctx.lineTo(W,y);
        ctx.stroke();
        ctx.fillText(i, 10,y-5);
      }
      ctx.setLineDash([]);

      // orange bar at bottom slice
      ctx.fillStyle = 'orange';
      ctx.fillRect(0, seg*7, W, seg);

      // border
      ctx.lineWidth = 6;
      ctx.strokeStyle = inFrame ? 'lime' : 'red';
      ctx.strokeRect(0,0,W,H);
    }

    // once video dimensions known
    video.addEventListener('loadedmetadata', ()=>{
      overlay.width  = video.videoWidth;
      overlay.height = video.videoHeight;
      drawOverlay();
    });

    // helper: draw the live overlay on every frame
    function animateOverlay(){
      drawOverlay();
      requestAnimationFrame(animateOverlay);
    }

    // countdown helper
    function countdown(sec, onTick, onDone){
      let s=sec;
      onTick(s);
      const iv = setInterval(()=>{
        s--;
        onTick(s);
        if(s<=0){
          clearInterval(iv);
          onDone();
        }
      },1000);
    }

    // Manual capture
    btnManual.addEventListener('click', ()=>{
      btnManual.disabled = true;
      countdown(5,
        s=>{
          // overlay big number
          ctx.fillStyle = 'rgba(0,0,0,0.5)';
          ctx.fillRect(0,0,overlay.width,overlay.height);
          ctx.fillStyle = 'white';
          ctx.font = 'bold 100px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText(s>0?s:'', overlay.width/2, overlay.height/2);
        },
        ()=>{
          takeSnapshot();
          btnManual.disabled = false;
        }
      );
    });

    btnReset.addEventListener('click', ()=>{
      inFrame = false;
      clearTimeout(countdownTimeout);
      animateOverlay();
    });

    // snapshot
    function takeSnapshot(){
      const c = document.createElement('canvas');
      c.width  = video.videoWidth;
      c.height = video.videoHeight;
      c.getContext('2d').drawImage(video,0,0);
      c.toBlob(blob=>{
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'aramandi.png';
        a.click();
        URL.revokeObjectURL(a.href);
      },'image/png');
    }

    // Mediapipe setup
    function onResults(results){
      // do we have forehead + both heels?
      const lm = results.poseLandmarks||[];
      if(lm.length){
        const topY   = overlay.height/8;      // slice1
        const orangeY= overlay.height*7/8;    // bottom bar
        const forehead = lm[10]; // approximate forehead via FaceMesh index 10
        const heelL    = lm[mp_pose.PoseLandmark.LEFT_HEEL.value];
        const heelR    = lm[mp_pose.PoseLandmark.RIGHT_HEEL.value];

        // convert normalized y to px
        const fy = forehead.y * overlay.height;
        const hly = (heelL.y*overlay.height + heelR.y*overlay.height)/2;

        // are we inâ€‘frame?
        if(fy < topY && hly > orangeY && !inFrame){
          inFrame = true;
          // start autoâ€‘capture countdown
          countdown(10,
            s=>{
              // show countdown
              ctx.fillStyle = 'rgba(0,0,0,0.4)';
              ctx.fillRect(0,0,overlay.width,overlay.height);
              ctx.fillStyle = 'white';
              ctx.font = 'bold 80px sans-serif';
              ctx.textAlign = 'center';
              ctx.fillText(`Hold still: ${s}`, overlay.width/2, overlay.height/2);
            },
            ()=>{
              takeSnapshot();
            }
          );
        }
      }
    }

    // wire up camera + Mediapipe
    const pose = new Pose({
      locateFile: f=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`
    });
    pose.setOptions({
      modelComplexity:1,
      smoothLandmarks:true,
      minDetectionConfidence:0.5,
      minTrackingConfidence:0.5
    });
    pose.onResults(onResults);

    const camera = new Camera(video, {
      onFrame: async () => { await pose.send({image:video}); },
      width: 720,
      height: 1280
    });
    camera.start().then(()=>animateOverlay());
  </script>
</body>
</html>
