<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Full‚ÄêBody Fixed Frame</title>
  <style>
    body { margin:0; padding:10px; text-align:center; font-family:Arial,sans-serif; background:#f0f0f0; }
    #layout { display:flex; flex-direction:column; align-items:center; gap:20px; }
    #canvas-wrap {
      position:relative;
      height:90vh;
      max-width:calc(90vh * 9 /16);
      background:#000;
    }
    #displayCanvas { width:100%; height:100%; display:block; }
    .btns { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
    button { padding:10px 20px; font-size:1em; }
    @media(min-width:900px){
      #layout { flex-direction:row; align-items:flex-start; }
      .btns { flex-direction:column; margin-left:20px; }
      button { padding:12px 18px; font-size:1.1em; }
    }
  </style>
</head>
<body>
  <h1>Full‚ÄêBody Fixed Frame</h1>
  <p>Keep your **entire** body inside the box (green‚ÄØ=‚ÄØgood, red‚ÄØ=‚ÄØany part outside).</p>
  <div id="layout">
    <div id="canvas-wrap">
      <video id="hiddenVideo" autoplay playsinline muted style="display:none;"></video>
      <canvas id="displayCanvas" width="720" height="1280"></canvas>
    </div>
    <div class="btns">
      <button id="snap">üì∏ Capture Photo</button>
      <button id="rec">üé• Record 10‚ÄØs Video</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>
  <script>
  (async()=>{
    // DOM
    const video = document.getElementById('hiddenVideo');
    const canvas = document.getElementById('displayCanvas');
    const ctx = canvas.getContext('2d');
    const snapBtn = document.getElementById('snap');
    const recBtn  = document.getElementById('rec');

    // 1) GET CAMERA (rear on mobile, front on desktop)
    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode: isMobile?'environment':'user' },
        audio:false
      });
      video.srcObject = stream;
      await video.play();
    } catch(e) {
      return alert('Camera failed: '+e.message);
    }

    // 2) SETUP SELFIE SEGMENTATION
    const seg = new SelfieSegmentation({
      locateFile: f=>'https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/'+f
    });
    seg.setOptions({ modelSelection:1 });
    let segMask = null;
    seg.onResults(r=>{ segMask = r.segmentationMask; });

    // 3) FIXED FRAME FRACTIONS
    const F = { minX:0.1, maxX:0.9, minY:0.1, maxY:0.9 };

    // 4) DRAW LOOP
    async function loop(){
      // draw camera into canvas (cover style)
      const vw=video.videoWidth, vh=video.videoHeight;
      const cw=canvas.width, ch=canvas.height;
      const s=Math.max(cw/vw, ch/vh),
            sw=cw/s, sh=ch/s,
            sx=(vw-sw)/2, sy=(vh-sh)/2;
      ctx.drawImage(video, sx,sy, sw,sh, 0,0, cw,ch);

      // run segmentation on the same frame
      await seg.send({image:canvas});

      // get mask pixels
      ctx.save();
      ctx.globalAlpha = 0.5;
      ctx.drawImage(segMask, 0,0, cw,ch);
      ctx.restore();

      // sample outside-box region for ANY person pixel
      const img = ctx.getImageData(0,0,cw,ch).data;
      const left = F.minX*cw, right = F.maxX*cw;
      const top  = F.minY*ch, bottom= F.maxY*ch;
      let anyOutside=false;

      // scan only a subset for speed: every 10px
      for(let y=0;y<ch && !anyOutside;y+=10){
        for(let x=0;x<cw && !anyOutside;x+=10){
          // if x,y is OUTSIDE the frame:
          if(x<left||x>right||y<top||y>bottom){
            const idx = (y*cw + x)*4;
            // mask drawn semi-transparent green; we check the GREEN channel strong
            if(img[idx+1] > 100){
              anyOutside=true;
            }
          }
        }
      }

      // draw fixed-frame border
      ctx.lineWidth=6;
      ctx.strokeStyle = anyOutside?'red':'lime';
      ctx.strokeRect(left, top, right-left, bottom-top);

      requestAnimationFrame(loop);
    }
    loop();

    // 5) SNAP PHOTO
    snapBtn.onclick = ()=>{
      canvas.toBlob(b=>{
        const a=document.createElement('a');
        a.href=URL.createObjectURL(b);
        a.download='photo.png';
        a.click();
      });
    };

    // 6) RECORD 10‚ÄØs VIDEO
    recBtn.onclick = ()=>{
      const recorder = new MediaRecorder(canvas.captureStream(30),{mimeType:'video/webm'});
      let parts=[];
      recorder.ondataavailable = e=>{ if(e.data.size) parts.push(e.data); };
      recorder.onstop = ()=>{
        const blob=new Blob(parts,{type:'video/webm'}), a=document.createElement('a');
        a.href=URL.createObjectURL(blob);
        a.download='video.webm';
        a.click();
      };
      recorder.start();
      setTimeout(()=>recorder.stop(),10000);
    };
  })();
  </script>
</body>
</html>
