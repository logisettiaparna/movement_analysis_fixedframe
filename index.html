<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Fixed‑Frame Aramandi Capture</title>
  <style>
    body { margin:0; padding:1rem; font-family:sans-serif; text-align:center; background:#f0f0f0 }
    h1 { margin-bottom:0.2em }
    #container {
      position:relative;
      margin:0 auto;
      width:90vw; max-width:720px;
      aspect-ratio:9/16;
      background:#000;
      overflow:hidden;
    }
    video {
      position:absolute;
      top:0; left:0;
      width:100%; height:100%;
      object-fit:contain;   /* <— no more zoom‑in */
      background:#000;
    }
    canvas#overlay {
      position:absolute;
      top:0; left:0;
      width:100%; height:100%;
      pointer-events:none;
    }
    #controls { margin-top:0.5em; display:flex; justify-content:center; gap:1em; flex-wrap:wrap }
    button { padding:0.6em 1.2em; font-size:1rem; }
    #countdown { margin-top:0.2em; font-size:1.5em; color:#d00; height:1.5em }
  </style>
</head>
<body>
  <h1>Fixed‑Frame Aramandi Capture</h1>
  <p>Stand so your <b>entire body</b> fills the window. It’ll turn <span style="color:green">green</span> only when every key landmark is inside.</p>

  <div id="container">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="overlay"></canvas>
  </div>

  <div id="controls">
    <button id="photo-btn">📸 Capture Photo</button>
    <button id="video-btn">🎥 Record 10 s Video</button>
  </div>
  <div id="countdown"></div>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script>
  const video     = document.getElementById('video'),
        overlay   = document.getElementById('overlay'),
        ctx       = overlay.getContext('2d'),
        photoBtn  = document.getElementById('photo-btn'),
        videoBtn  = document.getElementById('video-btn'),
        countdown = document.getElementById('countdown');

  let mediaRecorder, chunks=[];

  // 1) Initialize Pose
  const pose = new Pose({
    locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`
  });
  pose.setOptions({
    modelComplexity: 0,
    smoothLandmarks: true,
    minDetectionConfidence: 0.5,
    minTrackingConfidence: 0.5
  });
  pose.onResults(onResults);

  // 2) Start camera (front‑facing if available)
  new Camera(video, {
    onFrame: async () => await pose.send({image:video}),
    width: 1280, height: 720, facingMode: 'user'
  }).start();

  let landmarks = null;
  function onResults(res) {
    landmarks = res.poseLandmarks || null;
    drawOverlay();
  }

  // 3) Draw the 10%‑margin frame and check all landmarks inside it
  function drawOverlay() {
    const W = overlay.width = video.clientWidth,
          H = overlay.height = video.clientHeight;

    const margin = 0.1;
    const x0 = margin*W, x1 = (1-margin)*W,
          y0 = margin*H, y1 = (1-margin)*H;

    // default to red
    ctx.clearRect(0,0,W,H);
    ctx.lineWidth = 4;
    ctx.strokeStyle = 'red';

    // if we have landmarks, test each required one
    if (landmarks) {
      // map normalized to client coords
      const inside = landmarks.every(lm => {
        const x = lm.x * W, y = lm.y * H;
        return x>=x0 && x<=x1 && y>=y0 && y<=y1;
      });
      if (inside) ctx.strokeStyle = 'green';
    }

    // draw the frame
    ctx.strokeRect(x0,y0, x1-x0, y1-y0);
  }

  // 4) Countdown helper
  function startCountdown(sec, cb) {
    countdown.textContent = sec;
    let c=sec;
    const iv = setInterval(()=>{
      c>1 ? countdown.textContent = --c
            : (clearInterval(iv), countdown.textContent='', cb());
    },1000);
  }

  // 5) Capture Photo
  photoBtn.onclick = ()=>{
    if (!landmarks) return alert('Hold still until landmarks lock in.');
    startCountdown(5, ()=>{
      // grab the full video frame at native resolution
      const vw = video.videoWidth, vh = video.videoHeight;
      const cap = document.createElement('canvas');
      cap.width = vw; cap.height = vh;
      cap.getContext('2d').drawImage(video, 0,0,vw,vh);
      cap.toBlob(blob=>{
        const url = URL.createObjectURL(blob),
              a   = document.createElement('a');
        a.href = url; a.download='aramandi.png';
        a.click();
        URL.revokeObjectURL(url);
      }, 'image/png');
    });
  };

  // 6) Record 10 s Video
  videoBtn.onclick = ()=>{
    startCountdown(5, ()=>{
      chunks = [];
      if (!window.MediaRecorder) return alert('Recorder not supported');
      const stream = video.srcObject;
      try {
        mediaRecorder = new MediaRecorder(stream, {mimeType:'video/webm'});
      } catch(e) {
        return alert('✖️ ' + e);
      }
      mediaRecorder.ondataavailable = e=> e.data.size&&chunks.push(e.data);
      mediaRecorder.onstop = ()=>{
        const blob = new Blob(chunks, {type:'video/webm'});
        const url  = URL.createObjectURL(blob),
              a    = document.createElement('a');
        a.href = url; a.download='aramandi.webm';
        a.click();
        URL.revokeObjectURL(url);
      };
      mediaRecorder.start();
      setTimeout(()=>mediaRecorder.state!=='inactive'&&mediaRecorder.stop(), 10000);
    });
  };
  </script>
</body>
</html>
