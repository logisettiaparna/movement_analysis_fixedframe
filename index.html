<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Autoâ€‘Crop Aramandi</title>
  <style>
    * { box-sizing: border-box; margin:0; padding:0 }
    body {
      font-family:sans-serif;
      background:#f7f7f7;
      color:#333;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:1em;
    }
    h1 { margin-bottom:0.2em; font-size:1.5em; }
    p  { margin-bottom:1em; }
    #camera-container {
      position:relative;
      width:100%;
      max-width:360px;
      aspect-ratio:9/16;
      background:#000;
      overflow:hidden;
      border:4px solid #888;
    }
    video, canvas {
      position:absolute;
      top:0; left:0;
      width:100%; height:100%;
      object-fit:cover;
      transform:scaleX(-1);
    }
    #countdown {
      margin-top:.5em;
      font-size:2em;
      color:#c33;
      min-height:1.2em;
    }
    .btn-container {
      margin-top:1em;
      display:flex;
      gap:.5em;
    }
    .btn-container button {
      padding:.6em 1em;
      font-size:1em;
      border:1px solid #888;
      background:#fff;
      border-radius:4px;
      cursor:pointer;
      opacity:.4;
    }
    .btn-container button.enabled {
      opacity:1;
    }
  </style>
  <!-- MediaPipe Pose -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
</head>
<body>
  <h1>Smart Autoâ€‘Crop Aramandi</h1>
  <p>When your head &amp; feet hit the 1st &amp; 8th slices, weâ€™ll autoâ€‘capture.</p>

  <div id="camera-container">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="overlay"></canvas>
  </div>

  <div id="countdown"></div>

  <div class="btn-container">
    <button id="capture-btn" disabled>ðŸ“¸ Capture Photo</button>
    <button id="record-btn" disabled>ðŸŽ¥ Record 10Â s Video</button>
  </div>

  <script>
  (async()=>{
    const video       = document.getElementById('video');
    const overlay     = document.getElementById('overlay');
    const ctx         = overlay.getContext('2d');
    const btnPhoto    = document.getElementById('capture-btn');
    const btnRecord   = document.getElementById('record-btn');
    const countdownEl = document.getElementById('countdown');

    // 1) Setup camera at 720Ã—1280 ideal
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode:'user', width:{ideal:720}, height:{ideal:1280} },
      audio: false
    });
    video.srcObject = stream;
    await new Promise(r=>video.onloadedmetadata=r);
    overlay.width  = video.videoWidth;
    overlay.height = video.videoHeight;
    const W = overlay.width, H = overlay.height;

    // 2) MediaPipe Pose
    let inPosition = false;
    const pose = new Pose({locateFile:(f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${f}`});
    pose.setOptions({
      modelComplexity:0,
      smoothLandmarks:true,
      enableSegmentation:false,
      minDetectionConfidence:0.5,
      minTrackingConfidence:0.5
    });
    pose.onResults(drawFrame);

    // feed video into Pose
    const cam = new Camera(video, {onFrame:async()=>await pose.send({image:video}), width:W, height:H});
    cam.start();

    function drawFrame(results){
      ctx.clearRect(0,0,W,H);

      // draw mirrored video is automatic

      // draw orange pill at 7/8
      const yPill = Math.floor(H*7/8);
      ctx.fillStyle = '#f90'; ctx.globalAlpha = .8;
      ctx.fillRect(W*0.1, yPill-12, W*0.8, 24);
      ctx.globalAlpha=1;
      ctx.fillStyle='#fff';
      ctx.font='16px sans-serif';
      ctx.textAlign='center';
      ctx.fillText('Stand here â†’', W/2, yPill+6);

      // slicing lines & position check
      if(results.poseLandmarks){
        const lm = results.poseLandmarks;
        const noseY   = lm[0].y * H;  // nose
        const leftA   = lm[27].y * H; // left ankle
        const rightA  = lm[28].y * H; // right ankle
        // top slice = H/8, bottom slice = 7*H/8
        inPosition = (noseY < H/8) && 
                     (leftA > 7*H/8 && rightA > 7*H/8);
      } else inPosition = false;

      // long border
      ctx.strokeStyle = inPosition?'lime':'crimson';
      ctx.lineWidth = 4;
      ctx.strokeRect(0,0,W,H);

      // only draw the eight slices when ankles+nose in correct zone
      if(inPosition){
        ctx.strokeStyle = 'yellow';
        ctx.lineWidth = 1;
        ctx.setLineDash([4,3]);
        for(let i=1;i<8;i++){
          let y = Math.floor(H*i/8);
          ctx.beginPath();
          ctx.moveTo(0,y);
          ctx.lineTo(W,y);
          ctx.stroke();
        }
        ctx.setLineDash([]);
      }

      // enable/disable buttons
      [btnPhoto,btnRecord].forEach(b=>{
        b.disabled = !inPosition;
        b.classList.toggle('enabled', inPosition);
      });
    }

    // 3) Countdown
    function doCountdown(cb){
      let s=5;
      countdownEl.textContent = 'ðŸ“· '+s;
      const iv = setInterval(()=>{
        s--;
        countdownEl.textContent = s>0 ? 'ðŸ“· '+s : '';
        if(s<=0){
          clearInterval(iv);
          countdownEl.textContent = '';
          cb();
        }
      },1000);
    }

    // 4) Photo capture
    btnPhoto.onclick = ()=>{
      if(!inPosition) return;
      doCountdown(()=>{
        const c = document.createElement('canvas');
        c.width=W; c.height=H;
        c.getContext('2d').drawImage(video,0,0,W,H);
        c.toBlob(b=>{
          const a = document.createElement('a');
          a.href = URL.createObjectURL(b);
          a.download='aramandi.png';
          a.click();
          URL.revokeObjectURL(a.href);
        },'image/png');
      });
    };

    // 5) Video record
    btnRecord.onclick = ()=>{
      if(!inPosition) return;
      doCountdown(()=>{
        const recorder = new MediaRecorder(video.srcObject, {mimeType:'video/webm'});
        const parts = [];
        recorder.ondataavailable = e=>parts.push(e.data);
        recorder.onstop = ()=>{
          const blob = new Blob(parts,{type:'video/webm'});
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = 'aramandi.webm';
          a.click();
          URL.revokeObjectURL(a.href);
        };
        recorder.start();
        setTimeout(()=>recorder.stop(), 10000);
      });
    };

  })();
  </script>
</body>
</html>
