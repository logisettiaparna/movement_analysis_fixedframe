<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Auto‑Crop Aramandi</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: sans-serif;
      color: #333;
      text-align: center;
      padding: 1em;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 { margin-bottom: 0.3em; }
    p { margin-bottom: 1em; max-width: 500px; }

    #container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1em;
      width: 100%;
      max-width: 900px;
    }

    #camera-container {
      position: relative;
      width: 90vw;
      max-width: 400px;
      aspect-ratio: 9/16;
      overflow: hidden;
      border: 6px solid red;
      border-radius: 8px;
      background: #000;
    }
    #camera-container.video-ok { border-color: red; }
    #camera-container.valid { border-color: lime; }

    video, canvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 0.7em;
      width: 200px;
    }
    .box {
      padding: 0.8em;
      border: 2px solid #888;
      border-radius: 6px;
      min-height: 2.2em;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1em;
    }
    .countdown { font-size: 1.4em; font-weight: bold; }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5em;
      justify-content: center;
    }
    .controls button {
      flex: 1 1 100px;
      padding: 0.6em;
      font-size: 1em;
      border: 1px solid #888;
      background: #fff;
      color: #555;
      border-radius: 4px;
      cursor: not-allowed;
      opacity: 0.5;
    }
    .controls button.enabled {
      cursor: pointer;
      opacity: 1;
    }

    @media (min-width: 700px) {
      #container { flex-wrap: nowrap; }
    }
  </style>
</head>
<body>
  <h1>Smart Auto‑Crop Aramandi</h1>
  <p>Once your head clears the top slice and your feet sit on the orange bar, the border turns green and we auto‑capture after 5 s.</p>

  <div id="container">
    <div id="camera-container">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="overlay"></canvas>
    </div>
    <div class="sidebar">
      <div class="box" id="status">PLACE FEET ON ORANGE BAR</div>
      <div class="box countdown" id="countdown">&nbsp;</div>
      <div class="controls">
        <button id="capture-btn">📸 Capture</button>
        <button id="record-btn">🎥 Record 10 s</button>
      </div>
    </div>
  </div>

  <script>
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const ctx = overlay.getContext('2d');
    const container = document.getElementById('camera-container');
    const statusEl = document.getElementById('status');
    const countdownEl = document.getElementById('countdown');
    const capBtn = document.getElementById('capture-btn');
    const recBtn = document.getElementById('record-btn');

    let noseY=Infinity, heelMidY=Infinity;
    let aligned = false, countingDown = false;

    // request camera
    async function startCamera(){
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'user' },
          audio: false
        });
        video.srcObject = stream;
        container.classList.add('video-ok');
      } catch(e) {
        alert("❌ Camera access is required.\n" + e);
      }
    }
    startCamera();

    // resize canvas to match video
    video.addEventListener('loadedmetadata',()=>{
      overlay.width = video.videoWidth;
      overlay.height = video.videoHeight;
    });

    // draw 8 slices each frame
    function drawOverlay(){
      const W = overlay.width, H = overlay.height;
      ctx.clearRect(0,0,W,H);

      const seg = H/8;
      ctx.setLineDash([6,4]);
      ctx.lineWidth = 2;
      ctx.strokeStyle = 'yellow';
      for(let i=1;i<8;i++){
        const y = seg*i;
        ctx.beginPath();
        ctx.moveTo(0,y);
        ctx.lineTo(W,y);
        ctx.stroke();
      }
      ctx.setLineDash([]);
      // bottom bar
      ctx.fillStyle = 'orange';
      ctx.fillRect(0,7*seg, W, seg);
    }

    // dummy landmarks poll (replace with Pose if you want)
    // Here we'll approximate nose at center of frame for demo.
    // In your real app swap this with mediapipe or face detection.
    function estimateLandmarks(){
      // just center X, and vertical sniff:
      noseY = overlay.height * 0.1;         // pretend nose at top 10%
      heelMidY = overlay.height * 0.95;     // pretend feet at bottom 5%
    }

    function checkAlignment(){
      if(countingDown) return;  // freeze while countdown
      estimateLandmarks();
      const H = overlay.height;
      const topSlice = H/8;
      const bottomBound = 7*H/8;
      const isAligned = (noseY < topSlice) && (heelMidY > bottomBound);
      if(isAligned && !aligned){
        aligned = true;
        container.classList.add('valid');
        statusEl.textContent = '✔️ ALIGNED! Capturing in 5…';
        capBtn.classList.add('enabled'); capBtn.disabled = false;
        recBtn.classList.add('enabled'); recBtn.disabled = false;
        startCountdown();
      }
      if(!isAligned && aligned){
        aligned = false;
        container.classList.remove('valid');
        statusEl.textContent = 'PLACE FEET ON ORANGE BAR';
        countdownEl.textContent = '';
        capBtn.classList.remove('enabled'); capBtn.disabled = true;
        recBtn.classList.remove('enabled'); recBtn.disabled = true;
      }
    }

    function startCountdown(){
      countingDown = true;
      let s = 5;
      countdownEl.textContent = s;
      const iv = setInterval(()=>{
        s--;
        countdownEl.textContent = s>0 ? s : '🎉';
        if(s<=0){
          clearInterval(iv);
          doCapture();
          countingDown = false;
        }
      },1000);
    }

    function doCapture(){
      const c = document.createElement('canvas');
      c.width = video.videoWidth;
      c.height = video.videoHeight;
      c.getContext('2d').drawImage(video,0,0);
      c.toBlob(b=>{
        const a = document.createElement('a');
        a.href = URL.createObjectURL(b);
        a.download = 'aramandi.png';
        a.click();
        URL.revokeObjectURL(a.href);
      });
    }

    // manual fallback
    capBtn.addEventListener('click',doCapture);
    recBtn.addEventListener('click',()=>{
      alert("🎥 Record not implemented in this demo.");
    });

    // main loop
    function loop(){
      drawOverlay();
      if(container.classList.contains('video-ok')){
        checkAlignment();
      }
      requestAnimationFrame(loop);
    }
    loop();
  </script>
</body>
</html>
