<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Autoâ€‘Crop Aramandi</title>
  <style>
    * { box-sizing:border-box; margin:0; padding:0 }
    body {
      background:#f7f7f7;
      font-family:sans-serif;
      text-align:center;
      padding:1em;
    }
    h1 { margin-bottom:.2em }
    p  { margin-bottom:1em }
    #camera-container {
      position:relative;
      margin:0 auto;
      width:100%; max-width:400px;
      aspect-ratio:9/16;
      background:#000;
      overflow:hidden;
    }
    video, canvas {
      position:absolute; top:0; left:0;
      width:100%; height:100%;
      object-fit:cover;
    }
    .btn-container {
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:.5em;
      margin-top:1em;
    }
    .btn-container button {
      flex:1 1 140px;
      padding:.6em 1em;
      font-size:1em;
      border:1px solid #888;
      background:#fff;
      border-radius:4px;
      cursor:pointer;
    }
    @media(min-width:600px){
      .btn-container {
        position:absolute;
        top:50%;
        right:-180px;
        transform:translateY(-50%);
        flex-direction:column;
      }
    }
  </style>
</head>
<body>
  <h1>Smart Autoâ€‘Crop Aramandi</h1>
  <p>Frame your full bodyâ€”when your head & feet hit the 1st & 8th slices, weâ€™ll autoâ€‘capture.</p>

  <div id="camera-container">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="overlay"></canvas>
  </div>
  <div class="btn-container">
    <button id="record-video-btn">ðŸŽ¥ RecordÂ 10Â sÂ Video</button>
  </div>

  <!-- MediaPipe Pose -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.5/camera_utils.js"></script>
  <script>
  const video   = document.getElementById('video');
  const overlay = document.getElementById('overlay');
  const ctx     = overlay.getContext('2d');
  const btnVid  = document.getElementById('record-video-btn');

  let landmarks = null;
  let counting  = false;
  let cd        = 5;
  let cdTimer   = null;

  // 1) start camera
  navigator.mediaDevices.getUserMedia({video:{facingMode:'user'},audio:false})
    .then(s=> video.srcObject=s)
    .catch(e=> alert("Camera error: "+e));

  // 2) once we have a displayed size, sync canvas
  function resizeCanvas(){
    overlay.width  = overlay.clientWidth;
    overlay.height = overlay.clientHeight;
  }
  window.addEventListener('resize', resizeCanvas);
  video.addEventListener('loadedmetadata', resizeCanvas);

  // 3) set up Pose
  const pose = new Pose.Pose({
    locateFile: f=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${f}`
  });
  pose.setOptions({
    modelComplexity      : 1,
    smoothLandmarks      : true,
    minDetectionConfidence: 0.5,
    minTrackingConfidence : 0.5
  });
  pose.onResults(r=> landmarks = r.poseLandmarks);

  new Camera.Camera(video, {
    onFrame: async ()=> await pose.send({image:video}),
    width:1280, height:720
  }).start();

  // 4) draw border + 8 slices
  function drawOverlay(valid){
    const W = overlay.width, H = overlay.height;
    ctx.clearRect(0,0,W,H);

    // border
    ctx.lineWidth   = 4;
    ctx.strokeStyle = valid?'lime':'red';
    ctx.strokeRect(0,0,W,H);

    // slices
    const seg = H/8;
    ctx.lineWidth   = 2;
    ctx.strokeStyle = valid?'lime':'red';
    ctx.setLineDash([5,3]);
    ctx.font        = '20px sans-serif';
    ctx.fillStyle   = valid?'lime':'red';
    ctx.textAlign   = 'left';
    for(let i=1;i<8;i++){
      const y = seg*i;
      ctx.beginPath();
      ctx.moveTo(0,y);
      ctx.lineTo(W,y);
      ctx.stroke();
      ctx.fillText(i,10,y-5);
    }
    ctx.setLineDash([]);
  }

  // 5) are we aligned?
  function checkValid(){
    if(!landmarks) return false;
    const H = overlay.height;
    // nose tip = landmarkÂ 0
    const noseY = landmarks[0].y * H;

    // forehead: reflect eyeâ†’nose upward
    const leY = landmarks[1].y * H;
    const reY = landmarks[4].y * H;
    const eyeY= (leY+reY)/2;
    const fdY = eyeY - (noseY-eyeY);

    // feet: max of heels 27/28
    const lhY = landmarks[28].y * H;
    const rhY = landmarks[27].y * H;
    const ftY = Math.max(lhY,rhY);

    const topOK    = fdY < H/8;
    const bottomOK = ftY  > 7*H/8;

    // debug:
    // console.log({fdY, noseY, ftY, topOK, bottomOK});

    return topOK && bottomOK;
  }

  // 6) countdown + autoâ€‘capture
  function startCount(){
    counting = true;
    cd       = 5;
    cdTimer  = setInterval(()=>{
      if(!checkValid()){
        clearInterval(cdTimer);
        counting=false;
        return;
      }
      // overlay countdown
      drawOverlay(true);
      ctx.fillStyle = 'rgba(0,0,0,0.6)';
      ctx.fillRect(0,0,overlay.width,overlay.height);
      ctx.fillStyle='white';
      ctx.font='bold 100px sans-serif';
      ctx.textAlign='center';
      ctx.fillText(cd>0?cd:'', overlay.width/2, overlay.height/2);
      if(--cd < 0){
        clearInterval(cdTimer);
        capturePhoto();
        counting=false;
      }
    },1000);
  }

  function capturePhoto(){
    const c = document.createElement('canvas');
    c.width  = video.videoWidth;
    c.height = video.videoHeight;
    c.getContext('2d').drawImage(video,0,0);
    c.toBlob(b=>{
      const a=document.createElement('a');
      a.href=URL.createObjectURL(b);
      a.download='aramandi.png';
      a.click();
      URL.revokeObjectURL(a.href);
    },'image/png');
  }

  // 7) fallback 10Â s video
  btnVid.addEventListener('click',()=>{
    if(!window.MediaRecorder) return alert('No MediaRecorder');
    const rec = new MediaRecorder(video.srcObject,{mimeType:'video/webm'});
    const parts = [];
    rec.ondataavailable = e=>parts.push(e.data);
    rec.onstop = ()=>{
      const blob=new Blob(parts,{type:'video/webm'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download='aramandi.webm';
      a.click();
      URL.revokeObjectURL(a.href);
    };
    rec.start();
    setTimeout(()=>rec.state==='recording'&&rec.stop(),10000);
  });

  // 8) main loop
  function loop(){
    const ok = checkValid();
    if(ok && !counting)       startCount();
    if(!ok && counting)       { clearInterval(cdTimer); counting=false; }
    drawOverlay(ok);
    requestAnimationFrame(loop);
  }

  video.addEventListener('play',()=>{
    // start only once we have a valid display size
    resizeCanvas();
    loop();
  });
  </script>
</body>
</html>
