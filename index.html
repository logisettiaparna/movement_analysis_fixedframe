<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Smart Auto‚ÄëCrop Aramandi</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0 }
    body { font-family: sans-serif; background: #f0f0f0; text-align:center; padding:1em; }
    h1 { margin-bottom:0.2em; }
    #container { display:flex; flex-direction:column; align-items:center; position:relative; }
    video, canvas {
      position:absolute; top:0; left:0;
      width:100%; max-width:360px;
      aspect-ratio:9/16;
      object-fit:cover;
      background:#000;
    }
    #video { z-index:1; }
    #overlay { z-index:2; pointer-events:none; }
    #controls {
      margin-top:calc(9/16*360px + 1em);
      display:flex; flex-wrap:wrap; justify-content:center; gap:0.5em;
    }
    #controls button {
      padding:0.6em 1em; font-size:1em;
      border:1px solid #888; background:#fff; border-radius:4px;
      cursor:pointer;
    }
    #status {
      margin-top:1em; font-size:1.2em; font-weight:bold; min-height:1.4em;
    }
    @media (min-width:600px) {
      #container { flex-direction:row; align-items:flex-start; }
      #controls { flex-direction:column; margin-left:1em; margin-top:0; }
    }
  </style>
</head>
<body>
  <h1>Smart Auto‚ÄëCrop Aramandi</h1>
  <p>Get full‚Äëbody in view‚Äîwhen forehead clears top slice & ankles land on orange bar, you‚Äôre ‚ÄúIN FRAME.‚Äù Pose for 10¬†s then we auto‚Äëcapture.</p>

  <div id="container">
    <video id="video" autoplay playsinline></video>
    <canvas id="overlay"></canvas>
    <div id="controls">
      <button id="resetBtn">üîÑ Reset</button>
      <button id="manualBtn">üì∏ Capture Now</button>
    </div>
  </div>

  <div id="status"></div>

  <!-- Mediapipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script>
    const video    = document.getElementById('video');
    const overlay  = document.getElementById('overlay');
    const ctx      = overlay.getContext('2d');
    const resetBtn = document.getElementById('resetBtn');
    const manualBtn= document.getElementById('manualBtn');
    const statusEl = document.getElementById('status');

    let inFrame    = false;
    let counting   = false;

    // 1) Camera permission
    navigator.mediaDevices.getUserMedia({video:{facingMode:'user'},audio:false})
      .then(s=> video.srcObject=s)
      .catch(_=> alert("Please allow camera access"));

    video.addEventListener('loadedmetadata',()=>{
      overlay.width  = video.videoWidth;
      overlay.height = video.videoHeight;
    });

    function drawOverlay(good){
      const W = overlay.width, H = overlay.height;
      ctx.clearRect(0,0,W,H);

      // border
      ctx.lineWidth   = 6;
      ctx.strokeStyle = good?'lime':'red';
      ctx.strokeRect(0,0,W,H);

      // 7 dashed slices
      const slice = H/8;
      ctx.setLineDash([6,4]);
      ctx.lineWidth   = 2;
      ctx.strokeStyle = 'yellow';
      for(let i=1;i<8;i++){
        const y = slice*i;
        ctx.beginPath();
        ctx.moveTo(0,y);
        ctx.lineTo(W,y);
        ctx.stroke();
      }
      ctx.setLineDash([]);

      // bottom orange bar (1/8th high)
      ctx.fillStyle = 'orange';
      ctx.fillRect(0,H-slice,W,slice);
    }

    function startCountdown(secs, msgTemplate, onTick, onDone){
      let s=secs;
      onTick(s);
      const iv = setInterval(()=>{
        s--;
        if(s>0) onTick(s);
        else{
          clearInterval(iv);
          onDone();
        }
      },1000);
    }

    function capturePhoto(){
      const c = document.createElement('canvas');
      c.width = video.videoWidth; c.height = video.videoHeight;
      c.getContext('2d').drawImage(video,0,0);
      c.toBlob(b=>{
        const a = document.createElement('a');
        a.href = URL.createObjectURL(b);
        a.download = 'aramandi.png';
        a.click();
        URL.revokeObjectURL(a.href);
      });
    }

    // Mediapipe Pose
    const pose = new Pose.Pose({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`});
    pose.setOptions({modelComplexity:0, smoothLandmarks:true, minDetectionConfidence:0.5, minTrackingConfidence:0.5});
    pose.onResults(onPose);

    const cam = new Camera.Camera(video,{onFrame:async()=>{await pose.send({image:video});},width:720,height:1280});
    cam.start();

    function onPose(res){
      const lm = res.poseLandmarks;
      if(!lm){ drawOverlay(false); return; }

      // forehead approx: midpoint of inner eyes, shifted up
      const ie1=lm[Pose.PoseLandmark.LEFT_EYE_INNER], ie2=lm[Pose.PoseLandmark.RIGHT_EYE_INNER];
      const ex=(ie1.x+ie2.x)/2, ey=(ie1.y+ie2.y)/2 - 0.08;
      const headY = ey*overlay.height;

      // ankles midpoint
      const a1=lm[Pose.PoseLandmark.LEFT_ANKLE], a2=lm[Pose.PoseLandmark.RIGHT_ANKLE];
      const ay = ((a1.y+a2.y)/2)*overlay.height;

      const slice = overlay.height/8;
      const topOK  = headY < slice;
      const botOK  = ay > (overlay.height - slice) && ay <= overlay.height;

      const good = topOK && botOK;
      drawOverlay(good);

      // when first ‚Äúin frame‚Äù hit, start a 10s countdown for pose capture
      if(good && !inFrame && !counting){
        inFrame  = true;
        counting = true;
        statusEl.textContent = "‚úÖ IN FRAME ‚Äì pose now!";
        startCountdown(10,
          s => statusEl.textContent = `‚úÖ IN FRAME ‚Äì capturing in ${s}s‚Ä¶`,
          s => {},
          ()=>{
            capturePhoto();
            statusEl.textContent = "üì∑ Captured!";
            counting = false;
          }
        );
      }
    }

    // manual capture: 5s self‚Äëtimer
    manualBtn.onclick = ()=>{
      if(counting) return;
      inFrame=false; counting=true;
      statusEl.textContent = "üì∏ Manual ‚Äì capturing in 5s‚Ä¶";
      startCountdown(5,
        s=>statusEl.textContent=`üì∏ Manual ‚Äì capturing in ${s}s‚Ä¶`,
        s=>{},
        ()=>{
          capturePhoto();
          statusEl.textContent="üì∑ Captured!";
          counting=false;
        }
      );
    };

    resetBtn.onclick = ()=>{
      inFrame=false;
      counting=false;
      statusEl.textContent = "";
    };
  </script>
</body>
</html>
