<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Auto‚ÄëCrop Aramandi</title>
  <style>
    * { box-sizing:border-box; margin:0; padding:0 }
    body { background:#f7f7f7; font-family:sans-serif; color:#333; text-align:center; padding:1em }
    h1 { margin-bottom:0.2em }
    p  { margin-bottom:1em }
    .wrapper {
      display:flex; flex-wrap:wrap; justify-content:center; align-items:flex-start; gap:1em;
    }
    #camera-container {
      position:relative;
      width:100%; max-width:360px;
      aspect-ratio:9/16;
      background:#000; overflow:hidden;
    }
    video, canvas {
      position:absolute; top:0; left:0;
      width:100%; height:100%;
      object-fit:cover;
    }
    .controls {
      display:flex; flex-direction:column; gap:0.5em;
      width:140px;
    }
    .controls button {
      padding:0.6em; font-size:1em;
      border:1px solid #888; background:#fff; border-radius:4px;
      cursor:pointer;
    }
    .feedback { margin-top:0.5em; font-size:1.1em; font-weight:bold }
    @media(min-width:600px) {
      .wrapper { flex-wrap:nowrap }
    }
  </style>

  <!-- Mediapipe Pose -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
</head>
<body>
  <h1>Smart Auto‚ÄëCrop Aramandi</h1>
  <p>Get your full body in view ‚Äî forehead above the top slice and heels on the orange bar ‚Üí ‚ÄúIN¬†FRAME!‚Äù Hold 10¬†s to auto‚Äëcapture.</p>

  <div class="wrapper">
    <div id="camera-container">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="overlay"></canvas>
    </div>
    <div class="controls">
      <button id="reset">üîÑ Reset</button>
      <button id="manual">üì∏ Manual (5¬†s)</button>
      <div class="feedback" id="feedback">Loading‚Ä¶</div>
    </div>
  </div>

  <script>
    const video    = document.getElementById('video');
    const overlay  = document.getElementById('overlay');
    const ctx      = overlay.getContext('2d');
    const btnReset = document.getElementById('reset');
    const btnMan   = document.getElementById('manual');
    const fb       = document.getElementById('feedback');

    let inFrame = false, holdTimer = null;

    // draw slices, bar, border, keypoints
    function drawOverlay(fPt, hPt) {
      const W = overlay.width, H = overlay.height, seg = H/8;
      ctx.clearRect(0,0,W,H);

      // dashed slices 1‚Äì7
      ctx.lineWidth = 2;
      ctx.strokeStyle = 'yellow';
      ctx.setLineDash([5,5]);
      ctx.font = '18px sans-serif';
      ctx.fillStyle = 'yellow';
      for(let i=1; i<8; i++){
        const y = seg*i;
        ctx.beginPath();
        ctx.moveTo(0,y);
        ctx.lineTo(W,y);
        ctx.stroke();
        ctx.fillText(i, 10, y-5);
      }
      ctx.setLineDash([]);

      // orange bar = bottom slice
      ctx.fillStyle = 'orange';
      ctx.fillRect(0, seg*7, W, seg);

      // border
      ctx.lineWidth = 6;
      ctx.strokeStyle = inFrame ? 'lime' : 'red';
      ctx.strokeRect(0,0,W,H);

      // forehead & heel circles
      if(fPt){
        ctx.fillStyle = 'white';
        ctx.beginPath();
        ctx.arc(fPt.x, fPt.y, 8, 0, 2*Math.PI);
        ctx.fill();
        ctx.fillText('üë§', fPt.x+10, fPt.y-10);
      }
      if(hPt){
        ctx.fillStyle = 'white';
        ctx.beginPath();
        ctx.arc(hPt.x, hPt.y, 8, 0, 2*Math.PI);
        ctx.fill();
        ctx.fillText('üë£', hPt.x+10, hPt.y-10);
      }
    }

    function updateFeedback(msg){
      fb.textContent = msg;
    }

    function takeSnapshot(){
      const c = document.createElement('canvas');
      c.width = video.videoWidth;
      c.height= video.videoHeight;
      c.getContext('2d').drawImage(video,0,0);
      c.toBlob(blob=>{
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'aramandi.png';
        a.click();
      }, 'image/png');
    }

    function countdown(sec, onTick, onDone) {
      onTick(sec);
      let s = sec;
      const tid = setInterval(()=>{
        s--;
        onTick(s);
        if(s<=0){
          clearInterval(tid);
          onDone();
        }
      },1000);
      return tid;
    }

    btnMan.addEventListener('click', () => {
      btnMan.disabled = true;
      countdown(5,
        s => updateFeedback(`Manual in ${s}‚Ä¶`),
        ()=>{
          takeSnapshot();
          updateFeedback('Manual done.');
          btnMan.disabled = false;
        }
      );
    });

    btnReset.addEventListener('click', () => {
      inFrame = false;
      clearTimeout(holdTimer);
      updateFeedback('Position the camera.');
    });

    // Mediapipe Pose setup
    const pose = new Pose.Pose({
      locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`
    });
    pose.setOptions({
      modelComplexity: 1,
      smoothLandmarks: true,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });

    pose.onResults(results => {
      const W = overlay.width, H = overlay.height, seg = H/8;
      let fPt = null, hPt = null;

      // Forehead LM10 or eye‚Äëinner fallback
      if(results.multiFaceLandmarks?.length){
        const lm = results.multiFaceLandmarks[0].landmark[10];
        fPt = { x:lm.x*W, y:lm.y*H };
      } else if(results.poseLandmarks){
        const lm = results.poseLandmarks;
        const LE = lm[mp_pose.PoseLandmark.LEFT_EYE_INNER.value],
              RE = lm[mp_pose.PoseLandmark.RIGHT_EYE_INNER.value],
              NO = lm[mp_pose.PoseLandmark.NOSE.value];
        const ex = (LE.x+RE.x)/2, ey = (LE.y+RE.y)/2,
              d  = NO.y - ey;
        fPt = { x:ex*W, y:(ey - d)*H };
      }

      // heel midpoint
      if(results.poseLandmarks){
        const lm = results.poseLandmarks;
        const LH = lm[mp_pose.PoseLandmark.LEFT_HEEL.value],
              RH = lm[mp_pose.PoseLandmark.RIGHT_HEEL.value];
        hPt = {
          x: ((LH.x+RH.x)/2)*W,
          y: ((LH.y+RH.y)/2)*H
        };
      }

      drawOverlay(fPt,hPt);

      if(!fPt || !hPt){
        inFrame = false;
        updateFeedback('No person detected.');
        return;
      }
      const headOK = fPt.y < seg*1;
      const healOK = hPt.y >= seg*7 && hPt.y <= seg*8;

      if(!headOK){
        inFrame=false;
        updateFeedback('Move forehead above top slice.');
      }
      else if(!healOK){
        inFrame=false;
        updateFeedback('Place heels on the orange bar.');
      }
      else if(!inFrame){
        inFrame = true;
        updateFeedback('IN¬†FRAME! Hold 10¬†s‚Ä¶');
        holdTimer = countdown(10,
          s=>updateFeedback(`Auto capture in ${s}‚Ä¶`),
          ()=>{ takeSnapshot(); updateFeedback('Captured!'); }
        );
      }
    });

    // ask for camera, then start loop
    navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user' } })
      .then(stream=>{
        video.srcObject = stream;
        video.onloadeddata = () => {
          overlay.width  = video.videoWidth;
          overlay.height = video.videoHeight;
          video.play();
          updateFeedback('Position the camera.');
          // frame loop
          (function loop(){
            pose.send({image: video});
            requestAnimationFrame(loop);
          })();
        };
      })
      .catch(err=>{
        console.error(err);
        updateFeedback('‚ùó Camera access required.');
      });
  </script>
</body>
</html>
