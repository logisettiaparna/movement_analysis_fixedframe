<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Auto‑Crop Aramandi Capture</title>
  <style>
    body { margin:0; font-family:sans-serif; text-align:center; background:#f0f0f0; }
    h1 { margin:1rem 0 0.2rem; }
    #container {
      position:relative;
      margin:0 auto;
      width:90vw;
      max-width:720px;
      aspect-ratio:9/16;
      background:#000;
      overflow:hidden;
    }
    video, canvas {
      position:absolute; top:0; left:0;
      width:100%; height:100%;
      object-fit:cover;
    }
    #controls { margin:0.5rem; display:flex; justify-content:center; gap:1rem; flex-wrap:wrap; }
    button { padding:0.6rem 1.2rem; font-size:1rem; cursor:pointer; }
    #countdown { font-size:1.5rem; font-weight:bold; color:#d00; height:1.5em; }
  </style>
</head>
<body>
  <h1>Auto‑Crop Aramandi Capture</h1>
  <p>Frame your <b>full body</b> in view. Click “Capture” to start a 5 s countdown—stay still!</p>

  <div id="container">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>
  </div>

  <div id="controls">
    <button id="photo-btn">📸 Capture Photo</button>
    <button id="video-btn">🎥 Record 10 s Video</button>
  </div>
  <div id="countdown"></div>

  <!-- MediaPipe Pose + Camera Utils -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <script>
  const video     = document.getElementById('video');
  const canvas    = document.getElementById('canvas');
  const ctx       = canvas.getContext('2d');
  const photoBtn  = document.getElementById('photo-btn');
  const videoBtn  = document.getElementById('video-btn');
  const countdown = document.getElementById('countdown');
  let recorder, chunks = [];
  let cropBox = null;   // { x, y, w, h } in video‑pixel coords

  // 1) Init Pose
  const pose = new Pose({ locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}` });
  pose.setOptions({ modelComplexity:0, smoothLandmarks:true, minDetectionConfidence:0.5, minTrackingConfidence:0.5 });
  pose.onResults(onPose);

  // 2) Start camera
  new Camera(video, {
    onFrame: async () => await pose.send({image:video}),
    width:1280, height:720, facingMode:'user'
  }).start();

  // 3) Compute bounding‐box + margin + aspect‐fit to 9×16
  function onPose(r) {
    if(!r.poseLandmarks) return;
    const W = video.videoWidth,
          H = video.videoHeight;
    let minX=1, maxX=0, minY=1, maxY=0;
    for (let lm of r.poseLandmarks) {
      minX = Math.min(minX,lm.x);
      maxX = Math.max(maxX,lm.x);
      minY = Math.min(minY,lm.y);
      maxY = Math.max(maxY,lm.y);
    }
    // pad 20%
    const pad = 0.20*(maxY-minY);
    minY = Math.max(0, minY-pad);
    maxY = Math.min(1, maxY+pad);
    minX = Math.max(0, minX-pad);
    maxX = Math.min(1, maxX+pad);

    // raw crop in px
    let cw = (maxX-minX)*W;
    let ch = (maxY-minY)*H;
    // fit to 9×16 (w/h = 9/16)
    const target = 9/16;
    if (cw/ch > target) {
      // too wide → increase height
      const nh = cw/target;
      const delta = (nh - ch)/2;
      minY = Math.max(0, minY - delta/H);
      maxY = Math.min(1, maxY + delta/H);
      ch = nh;
    } else {
      // too tall → increase width
      const nw = ch*target;
      const delta = (nw - cw)/2;
      minX = Math.max(0, minX - delta/W);
      maxX = Math.min(1, maxX + delta/W);
      cw = nw;
    }
    // final box
    cropBox = {
      x: minX*W,
      y: minY*H,
      w: cw,
      h: ch
    };
  }

  // 4) continuously draw the cropped preview
  function draw() {
    if (cropBox) {
      const vw = video.clientWidth, vh = video.clientHeight;
      ctx.drawImage(
        video,
        cropBox.x, cropBox.y, cropBox.w, cropBox.h,
        0, 0, vw, vh
      );
    }
    requestAnimationFrame(draw);
  }
  draw();

  // countdown helper
  function startCountdown(sec, done) {
    countdown.textContent = sec;
    let c = sec;
    const tick = setInterval(()=>{
      c>1 ? countdown.textContent = --c
            : (clearInterval(tick), countdown.textContent='', done());
    },1000);
  }

  // 5) Capture Photo
  photoBtn.onclick = ()=>{
    if (!cropBox) return alert('Still initializing—please hold steady!');
    startCountdown(5, ()=>{
      const {x,y,w,h} = cropBox;
      const cap = document.createElement('canvas');
      cap.width = w; cap.height = h;
      cap.getContext('2d')
         .drawImage(video, x,y,w,h, 0,0,w,h);
      cap.toBlob(blob=>{
        const url = URL.createObjectURL(blob);
        const a   = document.createElement('a');
        a.href    = url;
        a.download= 'aramandi.png';
        a.click();
        URL.revokeObjectURL(url);
      },'image/png');
    });
  };

  // 6) Record 10 s Video
  videoBtn.onclick = ()=>{
    startCountdown(5, ()=>{
      chunks = [];
      if(!navigator.mediaDevices || !window.MediaRecorder)
        return alert('Recorder not supported');
      const stream = video.srcObject;
      try {
        recorder = new MediaRecorder(stream, { mimeType:'video/webm' });
      } catch(e) {
        return alert('Recorder error: '+e);
      }
      recorder.ondataavailable = e=> e.data.size&&chunks.push(e.data);
      recorder.onstop = ()=>{
        const blob = new Blob(chunks, { type:'video/webm' });
        const url  = URL.createObjectURL(blob);
        const a    = document.createElement('a');
        a.href     = url;
        a.download = 'aramandi.webm';
        a.click();
        URL.revokeObjectURL(url);
      };
      recorder.start();
      setTimeout(()=>recorder.state!=='inactive'&&recorder.stop(),10000);
    });
  };
  </script>
</body>
</html>
