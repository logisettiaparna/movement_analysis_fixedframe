<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Smart Auto‚ÄëCrop Aramandi Capture</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { margin:0; font-family:sans-serif; background:#f8f8f8; text-align:center; }
    h1 { margin:20px 0 0; }
    p { margin:10px 0 20px; }
    #container { position:relative; display:inline-block; max-width:90vw; }
    video, canvas { width:100%; height:auto; display:block; }
    #overlay { position:absolute; top:0; left:0; }
    #buttons {
      position: absolute;
      top:50%; right:-150px;
      display:flex; flex-direction:column; gap:10px;
      transform:translateY(-50%);
    }
    button {
      padding:12px 16px; font-size:1rem;
      background:#fff; border:1px solid #ccc; border-radius:4px;
      cursor:pointer;
    }
    @media(max-width:700px) {
      #buttons { position:static; transform:none; margin-top:10px; }
    }
  </style>
</head>
<body>

  <h1>Smart Auto‚ÄëCrop Aramandi Capture</h1>
  <p>Frame your full body in view, then tap ‚ÄúCapture‚Äù to start a 5‚ÄØs countdown.</p>

  <div id="container">
    <video id="video" autoplay playsinline></video>
    <canvas id="overlay"></canvas>
    <div id="buttons">
      <button id="capture">üì∏ Capture Photo (5‚ÄØs)</button>
      <button id="record">üé• Record 10‚ÄØs Video</button>
    </div>
  </div>

  <!-- MediaPipe Pose -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <script>
  (async()=>{

    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const ctx = overlay.getContext('2d');
    const captureBtn = document.getElementById('capture');
    const recordBtn  = document.getElementById('record');

    // fixed frame margins (10% each side)
    const frac = { x:0.1, y:0.1 };

    // Wait for video stream
    const stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:'user' }, audio:false
    });
    video.srcObject = stream;
    await new Promise(r=>video.onloadedmetadata=r);

    // size overlay to match
    overlay.width  = video.videoWidth;
    overlay.height = video.videoHeight;

    // compute pixel frame
    const frame = {
      x0: frac.x*video.videoWidth,
      y0: frac.y*video.videoHeight,
      x1: (1-frac.x)*video.videoWidth,
      y1: (1-frac.y)*video.videoHeight
    };

    // Pose detector
    const pose = new Pose({ locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}` });
    pose.setOptions({ modelComplexity:1, smoothLandmarks:true, minDetectionConfidence:0.5, minTrackingConfidence:0.5 });
    pose.onResults(onPose);

    // camera runner
    new Camera(video, {
      onFrame: async()=>await pose.send({ image:video }),
      width:video.videoWidth, height:video.videoHeight
    }).start();

    let lastLandmarks=null;
    function onPose(res){
      ctx.clearRect(0,0,overlay.width,overlay.height);

      if(res.poseLandmarks){
        lastLandmarks = res.poseLandmarks;
        // project and test if _all_ body landmarks inside frame
        let inside = true;
        for(const lm of res.poseLandmarks){
          const x = lm.x*overlay.width, y = lm.y*overlay.height;
          if(x<frame.x0||x>frame.x1||y<frame.y0||y>frame.y1){
            inside=false; break;
          }
        }
        // draw guide
        ctx.strokeStyle = inside?'lime':'red';
        ctx.lineWidth = 4;
        ctx.strokeRect(frame.x0,frame.y0,frame.x1-frame.x0, frame.y1-frame.y0);
      }
    }

    // helper to crop & download a canvas blob
    function downloadCanvasCrop(srcCanvas, bbox, name){
      const [x0,y0,x1,y1] = bbox;
      const w = x1-x0, h=y1-y0;
      const tmp = document.createElement('canvas');
      tmp.width = w; tmp.height = h;
      tmp.getContext('2d').drawImage(srcCanvas, x0,y0, w,h, 0,0, w,h);
      tmp.toBlob(blob=>{
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = name;
        a.click();
        URL.revokeObjectURL(a.href);
      },'image/png');
    }

    // PHOTO CAPTURE with 5s countdown
    captureBtn.onclick = ()=>{
      let t=5;
      captureBtn.disabled=true;
      const txt = captureBtn.textContent;
      const timer = setInterval(()=>{
        captureBtn.textContent = `Hold still‚Ä¶ ${t--}`;
        if(t<0){
          clearInterval(timer);
          captureBtn.textContent = txt;
          captureBtn.disabled=false;
          // snap
          const snap = document.createElement('canvas');
          snap.width=video.videoWidth; snap.height=video.videoHeight;
          snap.getContext('2d').drawImage(video,0,0);
          // determine body bbox from lastLandmarks
          if(!lastLandmarks){
            alert("No person detected!");
            return;
          }
          let minX=1,minY=1,maxX=0,maxY=0;
          for(const lm of lastLandmarks){
            minX = Math.min(minX, lm.x);
            minY = Math.min(minY, lm.y);
            maxX = Math.max(maxX, lm.x);
            maxY = Math.max(maxY, lm.y);
          }
          // expand a bit
          minX = Math.max(0, minX-0.05);
          minY = Math.max(0, minY-0.05);
          maxX = Math.min(1, maxX+0.05);
          maxY = Math.min(1, maxY+0.05);
          const bbox = [
            Math.floor(minX*snap.width),
            Math.floor(minY*snap.height),
            Math.ceil(maxX*snap.width),
            Math.ceil(maxY*snap.height)
          ];
          downloadCanvasCrop(snap, bbox, 'aramandi.png');
        }
      },1000);
    };

    // VIDEO RECORD up to 10s
    recordBtn.onclick = async()=>{
      recordBtn.disabled=true;
      const recorder = new MediaRecorder(stream, { mimeType:'video/webm' });
      const chunks = [];
      recorder.ondataavailable = e=>chunks.push(e.data);
      recorder.start();
      setTimeout(()=>recorder.stop(), 10000);
      recorder.onstop = ()=>{
        const blob = new Blob(chunks, { type:'video/webm' });
        const url  = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download='aramandi.webm';
        a.click();
        URL.revokeObjectURL(url);
        recordBtn.disabled=false;
      };
    };

  })();
  </script>
</body>
</html>
