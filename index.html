<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Auto‚ÄëCrop Aramandi</title>
  <style>
    * { box-sizing: border-box; margin:0; padding:0 }
    body { font-family:sans-serif; background:#f7f7f7; text-align:center; padding:1em }
    h1 { margin-bottom:0.2em }
    p { margin-bottom:1em }
    .wrapper { display:flex; flex-wrap:wrap; justify-content:center; align-items:flex-start; gap:1em }
    #camera-container {
      position:relative;
      width:100%; max-width:360px;
      aspect-ratio:9/16;
      background:#000; overflow:hidden;
    }
    video, canvas {
      position:absolute; top:0; left:0;
      width:100%; height:100%;
      object-fit:cover;
    }
    .controls {
      display:flex; flex-direction:column; gap:0.5em;
      width:140px;
    }
    .controls button {
      padding:0.6em; font-size:1em;
      border:1px solid #888; background:#fff; border-radius:4px;
      cursor:pointer;
    }
    .feedback {
      margin-top:0.5em;
      font-size:1.1em;
      font-weight:bold;
    }
    @media(min-width:600px){
      .wrapper { flex-wrap:nowrap }
    }
  </style>

  <!-- Mediapipe scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
</head>
<body>
  <h1>Smart Auto‚ÄëCrop Aramandi</h1>
  <p>Get your full body in view ‚Äî forehead above the top slice, heels on the orange bar ‚Üí ‚ÄúIN¬†FRAME!‚Äù Hold 10‚ÄØs to auto‚Äëcapture.</p>

  <div class="wrapper">
    <div id="camera-container">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="overlay"></canvas>
    </div>
    <div class="controls">
      <button id="reset">üîÑ Reset</button>
      <button id="manual">üì∏ Manual (5‚ÄØs)</button>
      <div class="feedback" id="feedback">Initializing‚Ä¶</div>
    </div>
  </div>

  <script>
    const video    = document.getElementById('video');
    const overlay  = document.getElementById('overlay');
    const ctx      = overlay.getContext('2d');
    const btnReset = document.getElementById('reset');
    const btnMan   = document.getElementById('manual');
    const fb       = document.getElementById('feedback');

    let inFrame = false, countdownID = null;

    // resize canvas to video once we know dimensions
    video.addEventListener('loadedmetadata', () => {
      overlay.width  = video.videoWidth;
      overlay.height = video.videoHeight;
      drawOverlay();
    });

    // draw the slices, bar, border
    function drawOverlay(){
      const W = overlay.width, H = overlay.height;
      ctx.clearRect(0,0,W,H);

      const seg = H/8;

      // dashed yellow slices 1‚Äì7
      ctx.lineWidth = 2;
      ctx.strokeStyle = 'yellow';
      ctx.setLineDash([5,5]);
      ctx.font = '18px sans-serif';
      ctx.fillStyle = 'yellow';
      for(let i=1;i<8;i++){
        const y = seg*i;
        ctx.beginPath();
        ctx.moveTo(0,y);
        ctx.lineTo(W,y);
        ctx.stroke();
        ctx.fillText(i, 10, y-5);
      }
      ctx.setLineDash([]);

      // solid orange bar = slice 8
      ctx.fillStyle = 'orange';
      ctx.fillRect(0, seg*7, W, seg);

      // thick red/green border
      ctx.lineWidth = 6;
      ctx.strokeStyle = inFrame ? 'lime' : 'red';
      ctx.strokeRect(0,0,W,H);
    }

    function updateFeedback(text){
      fb.textContent = text;
    }

    // snapshot helper
    function takeSnapshot(){
      const c = document.createElement('canvas');
      c.width  = video.videoWidth;
      c.height = video.videoHeight;
      c.getContext('2d').drawImage(video,0,0);
      c.toBlob(blob => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'aramandi.png';
        a.click();
      }, 'image/png');
    }

    // simple countdown
    function countdown(seconds, onTick, onDone){
      let s=seconds;
      onTick(s);
      const id = setInterval(()=>{
        s--;
        onTick(s);
        if(s<=0){
          clearInterval(id);
          onDone();
        }
      },1000);
      return id;
    }

    // Manual button
    btnMan.addEventListener('click', ()=>{
      btnMan.disabled = true;
      countdown(5,
        s => updateFeedback(`Capturing in ${s}‚Ä¶`),
        ()=>{
          takeSnapshot();
          btnMan.disabled = false;
          updateFeedback('Manual capture done.');
        }
      );
    });

    // Reset button
    btnReset.addEventListener('click', ()=>{
      inFrame = false;
      clearTimeout(countdownID);
      updateFeedback('Position the camera.');
    });

    // Pose callback
    function onResults(results){
      drawOverlay();

      if(!results.poseLandmarks) return;

      const lm = results.poseLandmarks;
      const seg = overlay.height/8;
      const topY   = seg*1;     // y of slice1
      const barTop = seg*7;     // y of top of orange bar
      const barBot = seg*8;     // bottom of frame

      // forehead via FaceMesh landmark #10, fallback nose if missing
      const forehead = lm[10] || lm[0];
      // heel midpoint
      const heelL = lm[mp_pose.PoseLandmark.LEFT_HEEL.value];
      const heelR = lm[mp_pose.PoseLandmark.RIGHT_HEEL.value];
      const hy = (heelL.y + heelR.y)/2 * overlay.height;
      const fy = forehead.y * overlay.height;

      // conditions
      const headOk = fy < topY;
      const heelOk = hy >= barTop && hy <= barBot;

      if(!headOk){
        inFrame = false;
        updateFeedback('Move your forehead above the top slice.');
      } else if(!heelOk){
        inFrame = false;
        updateFeedback('Place your heels in the orange bar.');
      } else if(!inFrame){
        // just went in‚Äëframe
        inFrame = true;
        updateFeedback('IN¬†FRAME! Hold 10‚ÄØs‚Ä¶');
        // auto‚Äëcapture after 10s
        countdownID = countdown(10,
          s => updateFeedback(`Capturing in ${s}‚Ä¶`),
          () => {
            takeSnapshot();
            updateFeedback('Captured!');
          }
        );
      }
    }

    // set up Mediapipe Pose + camera
    const pose = new Pose.Pose({ locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}` });
    pose.setOptions({
      modelComplexity: 1,
      smoothLandmarks: true,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });
    pose.onResults(onResults);

    const camera = new Camera.Camera(video, {
      onFrame: async () => await pose.send({ image: video }),
      width: 720,
      height: 1280
    });
    camera.start().then(()=>{
      updateFeedback('Position the camera.');
      drawOverlay();
    });
  </script>
</body>
</html>
