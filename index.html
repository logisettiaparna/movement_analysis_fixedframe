<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Autoâ€‘Crop Aramandi</title>
  <style>
    * { box-sizing:border-box; margin:0; padding:0; }
    body { font-family:sans-serif; background:#f7f7f7; color:#333; text-align:center; }
    h1 { margin-top:1em; font-size:1.5em; }
    #camera-container {
      position: relative;
      margin:1em auto;
      width:100%; max-width:360px;
      aspect-ratio:9/16;
      background:#000;
      overflow:hidden;
    }
    video, canvas {
      position:absolute; top:0; left:0;
      width:100%; height:100%;
      object-fit:cover;
    }
    #overlay { pointer-events:none; }
    .btns {
      display:flex; justify-content:center; gap:.5em; margin-bottom:2em;
    }
    .btns button {
      flex:1 1 120px; padding:.6em; font-size:1em;
      border:1px solid #888; background:#fff; border-radius:4px;
      cursor:pointer;
    }
    #countdown {
      position:absolute; bottom:1em; left:50%;
      transform:translateX(-50%);
      font-size:2em; color:white;
      text-shadow:0 0 4px #000;
    }
  </style>
</head>
<body>
  <h1>Smart Autoâ€‘Crop Aramandi</h1>
  <p>Frame your full bodyâ€”when your head & feet hit the 1st & 8th slices, weâ€™ll autoâ€‘capture.</p>

  <div id="camera-container">
    <video id="video" autoplay playsinline></video>
    <canvas id="overlay"></canvas>
    <div id="countdown"></div>
  </div>

  <div class="btns">
    <button id="btn-photo">ðŸ“¸ Capture Photo</button>
    <button id="btn-video">ðŸŽ¥ Record 10Â s Video</button>
  </div>

  <script type="module">
    import {Pose} from 'https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js';
    import {Camera} from 'https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js';

    const video = document.querySelector('#video');
    const canvas = document.querySelector('#overlay');
    const ctx    = canvas.getContext('2d');
    const cnt    = document.querySelector('#countdown');
    const btnP   = document.querySelector('#btn-photo');
    const btnV   = document.querySelector('#btn-video');

    let headY = null, footY = null;
    let readyToCapture = false;
    let countdownID;

    // set up Mediapipe Pose
    const pose = new Pose({
      locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${f}`
    });
    pose.setOptions({modelComplexity:1, smoothLandmarks:true, minDetectionConfidence:0.5});
    pose.onResults(onPose);

    // camera helper
    const cam = new Camera(video, {
      onFrame: async () => {
        await pose.send({image: video});
      },
      width: 360, height: 640,
      facingMode: 'user'
    });
    cam.start();

    // once video metadata is ready, size canvas
    video.addEventListener('loadedmetadata',()=>{
      canvas.width = video.videoWidth;
      canvas.height= video.videoHeight;
    });

    function onPose(results) {
      // clear
      ctx.clearRect(0,0,canvas.width,canvas.height);

      const H = canvas.height, W = canvas.width;
      const seg = H/8;

      // draw standâ€‘here box + dot
      const boxH = 40, dotSize = 12;
      ctx.fillStyle = 'rgba(255,165,0,0.9)';
      ctx.fillRect(0, H - boxH, W, boxH);
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 18px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('Stand here â†’', W/2, H - boxH/2 + 6);
      ctx.fillStyle = 'rgba(255,165,0,1)';
      ctx.beginPath();
      ctx.arc(W/2, H - seg + seg/8, dotSize, 0, 2*Math.PI);
      ctx.fill();

      if (results.poseLandmarks) {
        // find forehead (use midpoint of eyes minus offset)
        const lm = results.poseLandmarks;
        const leftEye = lm[1], rightEye = lm[4];
        const eyeX = (leftEye.x + rightEye.x)/2;
        const eyeY = (leftEye.y + rightEye.y)/2;
        const foreheadY = eyeY - (lm[0].y - eyeY);
        headY = foreheadY * H;

        // foot midpoint of heels
        const leftHeel = lm[27], rightHeel = lm[28];
        footY = ((leftHeel.y + rightHeel.y)/2) * H;

        // horizontal lines, red or green once head+foot hit
        readyToCapture = headY < seg && footY > 7*seg;
        ctx.lineWidth = 2;
        for (let i=1;i<8;i++){
          ctx.strokeStyle = readyToCapture ? 'lime' : 'red';
          ctx.setLineDash([4,4]);
          ctx.beginPath();
          ctx.moveTo(0, seg*i);
          ctx.lineTo(W, seg*i);
          ctx.stroke();
        }
        ctx.setLineDash([]);

        // autoâ€‘trigger
        if (readyToCapture && !countdownID) startCountdown();
      }

      // draw frame border in red/green
      ctx.lineWidth = 4;
      ctx.strokeStyle = readyToCapture ? 'lime' : 'red';
      ctx.strokeRect(0,0,W,H);
    }

    function startCountdown() {
      let s=5;
      cnt.textContent = s;
      countdownID = setInterval(()=>{
        s--;
        if (s>0) {
          cnt.textContent = s;
        } else {
          clearInterval(countdownID);
          cnt.textContent = '';
          capturePhoto();
          countdownID = null;
        }
      },1000);
    }

    function capturePhoto() {
      const c = document.createElement('canvas');
      c.width = video.videoWidth;
      c.height= video.videoHeight;
      c.getContext('2d').drawImage(video,0,0);
      c.toBlob(b=>{
        const a = document.createElement('a');
        a.href = URL.createObjectURL(b);
        a.download = 'aramandi.png';
        a.click();
        URL.revokeObjectURL(a.href);
      }, 'image/png');
    }

    btnP.addEventListener('click', ()=> {
      if (countdownID) return;
      readyToCapture = false;
      clearInterval(countdownID);
      startCountdown();
    });

    btnV.addEventListener('click', ()=> {
      if (!window.MediaRecorder) return alert('Recorder not supported');
      if (countdownID) return;
      readyToCapture = false;
      clearInterval(countdownID);
      startCountdown();
      // when countdown finishes, record 10Â s
      setTimeout(() => {
        const rec = new MediaRecorder(video.srcObject, {mimeType:'video/webm'});
        const chunks=[];
        rec.ondataavailable = e=>chunks.push(e.data);
        rec.onstop = ()=>{
          const blob = new Blob(chunks,{type:'video/webm'});
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = 'aramandi.webm';
          a.click();
          URL.revokeObjectURL(a.href);
        };
        rec.start();
        setTimeout(()=>rec.stop(),10000);
      }, 6000);
    });
  </script>
</body>
</html>
