<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Smart Autoâ€‘Crop Aramandi</title>
  <style>
    body { margin:0; padding:1em; font-family:sans-serif; text-align:center; background:#f0f0f0; }
    h1 { margin-bottom:0.2em; }
    p  { margin-bottom:1em; }
    #container {
      position: relative;
      width:100%; max-width:360px;
      aspect-ratio:9/16; margin:0 auto;
      background:#000; overflow:hidden;
    }
    video, canvas {
      position:absolute; top:0; left:0;
      width:100%; height:100%;
      object-fit:cover;
    }
    #overlay { pointer-events:none; }
    #countdown {
      position:absolute; top:8px; right:8px;
      background:rgba(0,0,0,0.6); color:#fff;
      padding:0.2em 0.5em; font-size:1.5em;
      border-radius:4px; display:none;
    }
    .controls {
      margin-top:1em; display:flex; gap:0.5em; flex-wrap:wrap;
      justify-content:center;
    }
    .controls button {
      flex:1 1 140px; padding:0.6em; font-size:1em;
      border:1px solid #888; background:#fff; border-radius:4px;
      cursor:pointer;
    }
    @media(min-width:600px) {
      .controls {
        position:absolute; top:50%; right:-180px;
        transform:translateY(-50%); flex-direction:column;
      }
    }
  </style>
</head>
<body>

  <h1>Smart Autoâ€‘Crop Aramandi</h1>
  <p>Get your full body in viewâ€”when your head clears the top slice and heels land on the orange bar, we autoâ€‘capture.</p>

  <div id="container">
    <video id="video" autoplay playsinline></video>
    <canvas id="overlay"></canvas>
    <div id="countdown"></div>
  </div>

  <div class="controls">
    <button id="snapBtn">ðŸ“¸ Capture Photo</button>
    <button id="recBtn">ðŸŽ¥ Record 10â€¯s Video</button>
    <button id="resetBtn">ðŸ”„ Reset</button>
  </div>

  <!-- MediaPipe Pose -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script>
  (async()=>{
    const video = document.getElementById('video');
    const canvas= document.getElementById('overlay');
    const ctx   = canvas.getContext('2d');
    const cd    = document.getElementById('countdown');
    const snapBtn = document.getElementById('snapBtn');
    const recBtn  = document.getElementById('recBtn');
    const resetBtn= document.getElementById('resetBtn');

    // prompt for camera
    const stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:'user' }, audio:false
    });
    video.srcObject = stream;
    video.addEventListener('loadedmetadata',()=>{
      canvas.width  = video.videoWidth;
      canvas.height = video.videoHeight;
    });

    // countdown helper
    let counting=false;
    function startCountdown(sec, onDone){
      counting=true;
      cd.style.display='block';
      let s=sec; cd.textContent=s;
      const iv = setInterval(()=>{
        s--, cd.textContent=s>0?s:'';
        if(s<0){ clearInterval(iv); cd.style.display='none'; counting=false; onDone(); }
      },1000);
    }

    // last capture timestampâ€”debounce auto snaps
    let lastAuto=0;

    // init MediaPipe Pose
    const pose = new Pose.Pose({
      locateFile:(f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`
    });
    pose.setOptions({
      modelComplexity:0,
      smoothLandmarks:true,
      minDetectionConfidence:0.5,
      minTrackingConfidence:0.5
    });
    pose.onResults(onPose);

    // feed camera into Pose
    const cam = new Camera.Camera(video, {
      onFrame: async()=> await pose.send({image:video}),
      width:720, height:1280
    });
    cam.start();

    function onPose(results){
      const W = canvas.width, H = canvas.height;
      ctx.clearRect(0,0,W,H);

      // draw raw video behind overlay
      ctx.globalCompositeOperation = 'source-over';
      ctx.drawImage(video,0,0,W,H);

      if(!results.poseLandmarks){
        return drawGuides(false);
      }

      // estimate forehead y (nose_y minus nose-to-forehead offset)
      const {y:x0} = results.poseLandmarks[0];  // NOSE
      const {y:x1} = results.poseLandmarks[1];  // RIGHT_EYE_INNER as fallback
      const approxForeheadY = (x0 - (x0 - x1)*0.6) * H;

      // heel midpoint
      const L = results.poseLandmarks[27], R = results.poseLandmarks[28];
      const heelY = Math.max(L.y,R.y) * H;

      // store in closure for guides
      window._headY = approxForeheadY;
      window._heelY = heelY;

      // now draw overlay guides
      drawGuides(approxForeheadY <= H/8 && heelY >= 7*H/8);

      // autoâ€‘capture if valid for 5â€¯s and >5â€¯s since last
      if(!counting && approxForeheadY <= H/8 && heelY >= 7*H/8){
        const now=Date.now();
        if(now - lastAuto > 5000){
          lastAuto = now;
          startCountdown(5, ()=>snap());
        }
      }
    }

    function drawGuides(valid){
      const W=canvas.width, H=canvas.height;
      const slice=H/8;

      // border
      ctx.lineWidth=8;
      ctx.strokeStyle = valid ? 'lime' : 'red';
      ctx.strokeRect(0,0,W,H);

      // dashed horizontal slices
      ctx.lineWidth=3;
      ctx.setLineDash([6,4]);
      ctx.strokeStyle = valid ? 'lime' : 'red';
      for(let i=1;i<8;i++){
        const y=i*slice;
        ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke();
      }
      ctx.setLineDash([]);

      // orange bar on bottom slice
      ctx.fillStyle='orange';
      ctx.fillRect(0,7*slice, W, slice);
    }

    function snap(){
      const a = document.createElement('a');
      a.href = canvas.toDataURL('image/png');
      a.download='aramandi.png';
      a.click();
    }

    snapBtn .addEventListener('click',()=>{
      if(counting)return;
      startCountdown(5, ()=>snap());
    });
    recBtn .addEventListener('click',()=>{
      if(counting)return;
      startCountdown(5, ()=>{
        const rec = new MediaRecorder(stream, {mimeType:'video/webm'});
        const parts = [];
        rec.ondataavailable = e=>parts.push(e.data);
        rec.onstop = ()=>{
          const blob=new Blob(parts,{type:'video/webm'});
          const url=URL.createObjectURL(blob);
          const a=document.createElement('a');
          a.href=url; a.download='aramandi.webm'; a.click();
          URL.revokeObjectURL(url);
        };
        rec.start();
        setTimeout(()=>rec.state!=='inactive'&&rec.stop(),10000);
      });
    });
    resetBtn.addEventListener('click',()=>{
      counting=false;
      cd.style.display='none';
    });

  })();
  </script>

</body>
</html>
