<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Auto‚ÄëCrop Aramandi</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #f7f7f7; font-family: sans-serif; color: #333; text-align: center; padding: 1em; }
    h1 { margin-bottom: 0.2em; }
    p { margin-bottom: 1em; }
    #camera-container {
      position: relative;
      margin: 0 auto;
      width: 90vw;
      max-width: 360px;
      aspect-ratio: 9/16; /* 360√ó640 */
      background: #000;
      overflow: hidden;
      border: 6px solid red;
    }
    video, canvas {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.5em;
      margin-top: 1em;
    }
    .controls button {
      flex: 1 1 140px;
      padding: 0.6em;
      font-size: 1em;
      border: 1px solid #888;
      background: #fff;
      border-radius: 4px;
      cursor: pointer;
    }
    #feedback { margin-top: 0.5em; font-weight: bold; }
    @media (min-width: 600px) {
      #camera-container { float: left; margin-right: 2em; }
      .controls { flex-direction: column; width: 200px; margin-top: 0; }
    }
  </style>
</head>
<body>
  <h1>Smart Auto‚ÄëCrop Aramandi</h1>
  <p>Get full‚Äëbody in view¬†‚Äî forehead clears the top slice and heels land in the orange bar ‚Üí ‚ÄúIN FRAME!‚Äù  Hold 10¬†s to auto‚Äëcapture.</p>

  <div id="camera-container">
    <video id="video" autoplay muted playsinline></video>
    <canvas id="overlay"></canvas>
  </div>

  <div class="controls">
    <button id="resetBtn">üîÑ Reset</button>
    <button id="manualBtn">üì∏ Manual (5¬†s)</button>
  </div>
  <div id="feedback">Loading‚Ä¶</div>

  <!-- MediaPipe & camera utils -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.1/camera_utils.js"></script>

  <script>
  (async()=>{
    const video    = document.getElementById('video');
    const canvas   = document.getElementById('overlay');
    const ctx      = canvas.getContext('2d');
    const resetBtn = document.getElementById('resetBtn');
    const manualBtn= document.getElementById('manualBtn');
    const fb       = document.getElementById('feedback');
    const W=360, H=640, seg=H/8, barY=seg*7;

    let inFrameStart = null;
    let autoTimer    = null;
    let manualTimer  = null;
    let capturing    = false;

    function updateFeedback(msg, color='#333'){
      fb.textContent = msg;
      fb.style.color = color;
    }

    // draw slices, bar, and border
    function drawOverlay(landmarks){
      ctx.clearRect(0,0,W,H);
      // slices
      ctx.strokeStyle = 'yellow';
      ctx.lineWidth   = 2;
      ctx.setLineDash([6,4]);
      ctx.font        = '20px sans-serif';
      ctx.fillStyle   = 'yellow';
      for(let i=1;i<8;i++){
        const y=seg*i;
        ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke();
        ctx.fillText(String(i), 10, y-5);
      }
      ctx.setLineDash([]);
      // orange bar
      ctx.fillStyle = 'rgba(255,165,0,0.5)';
      ctx.fillRect(0, barY, W, seg);

      // if we have landmarks, mark forehead & heel mid
      if(landmarks){
        const fh=landmarks.forehead, hm=landmarks.heelMid;
        const fx=fh.x*W, fy=fh.y*H;
        const hx=hm.x*W, hy=hm.y*H;
        ctx.fillStyle='cyan';
        ctx.beginPath(); ctx.arc(fx,fy,6,0,2*Math.PI); ctx.fill();
        ctx.beginPath(); ctx.arc(hx,hy,6,0,2*Math.PI); ctx.fill();
      }
    }

    // check if in‚Äëframe
    function checkInFrame(lm){
      if(!lm) return false;
      const fy = lm.forehead.y*H;
      const hy = lm.heelMid.y  *H;
      return fy < seg && hy > barY;
    }

    // attempt capture
    function attemptAutoCapture(){
      if(inFrameStart===null){
        inFrameStart = performance.now();
        updateFeedback('IN FRAME¬†‚Äì hold 10¬†s', 'lime');
      }
      const elapsed = (performance.now()-inFrameStart)/1000;
      if(elapsed>=10 && !capturing){
        capturing=true;
        captureImage();
      }
    }
    function resetAuto(){
      inFrameStart = null;
      capturing    = false;
      if(autoTimer) clearTimeout(autoTimer);
      updateFeedback('Align forehead & heels', 'red');
    }

    // capture to download
    function captureImage(){
      updateFeedback('üì∏ Captured!', 'lime');
      const c = document.createElement('canvas');
      c.width  = W; c.height = H;
      c.getContext('2d').drawImage(video,0,0,W,H);
      c.toBlob(b=>{
        const a=document.createElement('a');
        a.href=URL.createObjectURL(b);
        a.download=`aramandi_${Date.now()}.png`;
        a.click();
      },'image/png');
    }

    // manual capture
    manualBtn.onclick = ()=>{
      if(manualTimer) return;
      updateFeedback('Prepare‚Ä¶', 'orange');
      let n=5;
      const iv=setInterval(()=>{
        updateFeedback(`Manual in ${n--}s`, 'orange');
        if(n<0){
          clearInterval(iv);
          captureImage();
          manualTimer=null;
        }
      },1000);
      manualTimer = iv;
    };

    resetBtn.onclick = ()=>{
      resetAuto();
    };

    // set up video‚ÜíPose
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode:'user', width:W, height:H }, audio:false
      });
      video.srcObject = stream;
      await video.play();
    } catch(e){
      console.error(e);
      updateFeedback('‚ùó camera access required', 'crimson');
      return;
    }

    // size our canvas
    canvas.width = W; canvas.height = H;
    document.querySelector('#camera-container').style.borderColor='red';
    updateFeedback('Align forehead & heels','red');

    // load Pose
    const pose = new Pose({
      locateFile: f=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${f}`
    });
    pose.setOptions({
      selfieMode: true,
      modelComplexity: 1,
      smoothLandmarks: true,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });
    pose.onResults(results=>{
      let lm = null;
      if(results.poseLandmarks){
        const p=results.poseLandmarks;
        // forehead from nose + eye inner midpoint
        const eyeInnerX = (p[1].x + p[4].x)/2;
        const eyeInnerY = (p[1].y + p[4].y)/2;
        const noseY      = p[0].y;
        const foreY      = eyeInnerY - (noseY-eyeInnerY);
        // heel midpoint
        const lh=p[27], rh=p[28];
        lm = {
          forehead: { x: eyeInnerX, y: foreY },
          heelMid:  { x: (lh.x+rh.x)/2, y: (lh.y+rh.y)/2 }
        };
      }
      drawOverlay(lm);

      if(checkInFrame(lm)){
        document.querySelector('#camera-container')
                .style.borderColor='lime';
        attemptAutoCapture();
      } else {
        document.querySelector('#camera-container')
                .style.borderColor='red';
        inFrameStart = null;
      }
    });

    // start feeding frames
    const camera = new Camera(video, {
      onFrame: async()=> await pose.send({ image: video }),
      width: W, height: H
    });
    camera.start();
  })();
  </script>
</body>
</html>
