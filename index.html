<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Autoâ€‘Crop Aramandi</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0 }
    body { font-family: sans-serif; color: #333; text-align: center; padding: 1em; }
    h1 { margin-bottom: 0.2em; }
    p { margin-bottom: 1em; }
    #camera-container {
      position: relative;
      margin: 0 auto;
      width: 90vw;
      max-width: 400px;
      aspect-ratio: 9 / 16;
      background: #000;
      overflow: hidden;
      border: 4px solid red;
      border-radius: 8px;
    }
    #video, #overlay {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
    }
    .status-box, .countdown-box {
      margin-top: 0.7em;
      padding: 0.6em;
      border: 2px solid #888;
      border-radius: 6px;
      font-size: 1.1em;
      min-height: 2.2em;
    }
    .countdown-box { margin-top: 0.5em; }
    .controls {
      margin-top: 1em;
      display: flex;
      justify-content: center;
      gap: 0.5em;
    }
    .controls button {
      flex: 1 1 140px;
      padding: 0.6em;
      font-size: 1em;
      border: 1px solid #888;
      background: #fff;
      color: #555;
      border-radius: 4px;
      cursor: not-allowed;
      opacity: 0.5;
    }
    .controls button.enabled {
      cursor: pointer;
      opacity: 1;
    }
  </style>
</head>
<body>
  <h1>Smart Autoâ€‘Crop Aramandi</h1>
  <p>Once your head clears the top slice and your feet land on the orange bar, weâ€™ll autoâ€‘capture.</p>

  <div id="camera-container">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="overlay"></canvas>
  </div>

  <div class="status-box" id="status">PLACE FEET ON ORANGE BAR</div>
  <div class="countdown-box" id="countdown">&nbsp;</div>

  <div class="controls">
    <button id="capture-btn">ðŸ“¸ Capture</button>
    <button id="record-btn">ðŸŽ¥ Record 10Â s</button>
  </div>

  <script type="module">
    import { Pose } from 'https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js';
    import { Camera } from 'https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js';

    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const ctx = overlay.getContext('2d');
    const statusEl = document.getElementById('status');
    const countdownEl = document.getElementById('countdown');
    const capBtn = document.getElementById('capture-btn');
    const recBtn = document.getElementById('record-btn');

    let latestLandmarks = null;

    // mediaâ€‘pipe Pose setup
    const pose = new Pose({locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${f}`});
    pose.setOptions({modelComplexity: 0, smoothLandmarks: true});
    pose.onResults(r => latestLandmarks = r.poseLandmarks);

    // camera
    const cam = new Camera(video, {
      onFrame: async () => {
        await pose.send({image: video});
        drawOverlay();
        checkAlignment();
      },
      width: 360,
      height: 640
    });
    cam.start();

    // resize canvas to video
    video.addEventListener('loadedmetadata', () => {
      overlay.width = video.videoWidth;
      overlay.height = video.videoHeight;
    });

    function drawOverlay() {
      const W = overlay.width, H = overlay.height;
      ctx.clearRect(0,0,W,H);

      // eightâ€‘head slices
      const seg = H/8;
      for(let i=1;i<8;i++){
        ctx.beginPath();
        ctx.setLineDash([6,4]);
        ctx.lineWidth = 2;
        ctx.strokeStyle = 'yellow';
        ctx.moveTo(0, seg*i);
        ctx.lineTo(W, seg*i);
        ctx.stroke();
      }
      ctx.setLineDash([]);

      // bottom slice as orange bar
      ctx.fillStyle = 'orange';
      ctx.fillRect(0, seg*7, W, seg);

      // border color will come from checkAlignment()
    }

    function checkAlignment() {
      if(!latestLandmarks) {
        setInvalid();
        return;
      }
      const H = overlay.height, W = overlay.width;
      // forehead = midpoint between left/right eye inner
      const le = latestLandmarks[1], re = latestLandmarks[0], no = latestLandmarks[0];
      // Actually use NOSE for tip, and Eye inner corners for head top â€’ rough:
      // Use landmark 0 = nose, landmark 1 = mouth?
      const noseY = latestLandmarks[0].y * H;
      const footY = ((latestLandmarks[27].y + latestLandmarks[28].y)/2) * H; // ankles
      const topSlice = H/8;
      const bottomSlice = 7*H/8 + 5;  // give 5px slack into orange

      if(noseY < topSlice && footY > bottomSlice){
        setValid();
      } else {
        setInvalid();
      }
    }

    function setValid() {
      overlay.parentElement.style.borderColor = 'lime';
      statusEl.textContent = 'âœ”ï¸ ALIGNED! Starting countdownâ€¦';
      if(!capBtn.classList.contains('enabled')){
        capBtn.classList.add('enabled');
        capBtn.disabled = false;
        recBtn.classList.add('enabled');
        recBtn.disabled = false;
        startAutoCapture();
      }
    }
    function setInvalid() {
      overlay.parentElement.style.borderColor = 'red';
      statusEl.textContent = 'PLACE FEET ON ORANGE BAR';
      capBtn.classList.remove('enabled'); capBtn.disabled = true;
      recBtn.classList.remove('enabled'); recBtn.disabled = true;
      countdownEl.textContent = '';
    }

    function startAutoCapture() {
      let s = 5;
      countdownEl.textContent = s;
      const iv = setInterval(() => {
        s--;
        countdownEl.textContent = s>0 ? s : 'ðŸŽ‰';
        if(s<=0){
          clearInterval(iv);
          doCapture();
        }
      },1000);
    }

    function doCapture() {
      const c = document.createElement('canvas');
      c.width = video.videoWidth;
      c.height = video.videoHeight;
      c.getContext('2d').drawImage(video,0,0);
      c.toBlob(b => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(b);
        a.download = 'aramandi.png';
        a.click();
        URL.revokeObjectURL(a.href);
      });
    }

    // manual buttons (if you still want them)
    capBtn.addEventListener('click', doCapture);
    recBtn.addEventListener('click', () => {
      // similar MediaRecorder logic as beforeâ€¦
      alert('Recording not implemented in this snippet');
    });
  </script>
</body>
</html>
